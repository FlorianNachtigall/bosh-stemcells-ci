- path: /groups/name=((group))/jobs/-
  type: replace
  value: aggregate-candidate-stemcells-((group))

- path: /jobs/-
  type: replace
  value:
    name: aggregate-candidate-stemcells-((group))
    serial: true
    plan:
    - aggregate:
      - get: version
        trigger: true
        resource: version-((group))
        passed:
        - test-stemcells-((group))
        - bats-((group))
      - get: bosh-stemcells-ci
      - get: bosh-linux-stemcell-builder
        resource: bosh-linux-stemcell-builder-((group))
        passed:
        - bats-((group))
      - get: stemcells-index
      - get: stemcell-trigger-((group))
        passed:
        - test-stemcells-((group))
        - bats-((group))
        trigger: true
    - file: bosh-stemcells-ci/pipelines/ubuntu-xenial/((group))/tasks/assert-version-aligns.yml
      task: assert-version-aligns
    - file: bosh-stemcells-ci/tasks/publish.yml
      params:
        AWS_ACCESS_KEY_ID: ((stemcell_aws_access_key))
        AWS_SECRET_ACCESS_KEY: ((stemcell_aws_secret_key))
        COMMIT_PREFIX: candidate
        FROM_BUCKET_NAME: bosh-core-stemcells-candidate
        FROM_INDEX: dev
        TO_BUCKET_NAME: bosh-core-stemcells-candidate
        TO_INDEX: candidate
        OS_NAME: ubuntu
        OS_VERSION: xenial
        COPY_KEYS: |
          aws/bosh-stemcell-%s-aws-xen-hvm-ubuntu-xenial-go_agent.tgz
          google/bosh-stemcell-%s-google-kvm-ubuntu-xenial-go_agent.tgz
          openstack/bosh-stemcell-%s-openstack-kvm-ubuntu-xenial-go_agent.tgz
          openstack/bosh-stemcell-%s-openstack-kvm-ubuntu-xenial-go_agent-raw.tgz
          warden/bosh-stemcell-%s-warden-boshlite-ubuntu-xenial-go_agent.tgz
          vsphere/bosh-stemcell-%s-vsphere-esxi-ubuntu-xenial-go_agent.tgz
          vcloud/bosh-stemcell-%s-vcloud-esxi-ubuntu-xenial-go_agent.tgz
          azure/bosh-stemcell-%s-azure-hyperv-ubuntu-xenial-go_agent.tgz
      task: copy-artifacts
    - aggregate:
      - params:
          only_tag: true
          repository: bosh-linux-stemcell-builder
          tag: version-tag/tag
        put: bosh-linux-stemcell-builder-push-((group))
      - params:
          rebase: true
          repository: stemcells-index
        put: stemcells-index
    serial: true
