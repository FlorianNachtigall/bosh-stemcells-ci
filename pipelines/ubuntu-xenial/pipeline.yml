#@ load("@ytt:data", "data")
groups:
#@ for stemcell in data.values.stemcells:
- name: build-(@= stemcell.version @)
  jobs:
  - build-stemcell-(@= stemcell.version @)
  - test-unit-(@= stemcell.version @)
  - build-os-image-(@= stemcell.version @)
  - stemcell-trigger-start-(@= stemcell.version @)
  - build-vcloud-esxi-(@= stemcell.version @)
  - build-vsphere-esxi-(@= stemcell.version @)
  - build-openstack-kvm-(@= stemcell.version @)
  - build-google-kvm-(@= stemcell.version @)
#@ if stemcell.include_alicloud:
  - build-alicloud-kvm-(@= stemcell.version @)
#@ end
  - build-azure-hyperv-(@= stemcell.version @)
  - build-aws-xen-hvm-(@= stemcell.version @)
  - build-warden-boshlite-(@= stemcell.version @)
#@ if stemcell.version == "master":
  - promote-bosh-agent-develop
#@ elif stemcell.version == "97.x":
  - promote-bosh-agent-97.x
#@ elif stemcell.version == "170.x":
  - promote-bosh-agent-170.x
#@ elif stemcell.version == "250.x":
  - promote-bosh-agent-250.x
#@ elif stemcell.version == "315.x":
  - promote-bosh-agent-315.x
#@ end
  - repack-stemcell-vsphere-esxi-(@= stemcell.version @)
  - repack-stemcell-vcloud-esxi-(@= stemcell.version @)
  - repack-stemcell-openstack-kvm-(@= stemcell.version @)
  - repack-stemcell-openstack-kvm-raw-(@= stemcell.version @)
  - repack-stemcell-google-kvm-(@= stemcell.version @)
#@ if stemcell.include_alicloud:
  - repack-stemcell-alicloud-kvm-(@= stemcell.version @)
#@ end
  - repack-stemcell-azure-hyperv-(@= stemcell.version @)
  - repack-stemcell-aws-xen-hvm-(@= stemcell.version @)
  - repack-stemcell-warden-boshlite-(@= stemcell.version @)
  - bats-(@= stemcell.version @)
  - test-stemcells-(@= stemcell.version @)
#@ if stemcell.version != "master":
  - aggregate-candidate-stemcells-(@= stemcell.version @)
#@ end
#@ if stemcell.version == "master":
- name: agent-(@= stemcell.version @)
  jobs:
  - test-unit-bosh-agent-develop
  - test-integration-bosh-agent-develop
  - bosh-integration-tests-bosh-agent-develop
  - windows-test-unit-bosh-agent-develop
  - windows-test-integration-2019-bosh-agent-develop
  - windows-test-integration-1803-bosh-agent-develop
  - windows-test-integration-2012R2-bosh-agent-develop
  - promote-bosh-agent-develop
  - bump-deps-bosh-agent-develop
#@ end
#@ if stemcell.version == "97.x":
- name: agent-97.x
  jobs:
  - test-unit-bosh-agent-97.x
  - test-integration-bosh-agent-97.x
  - promote-bosh-agent-97.x
#@ end
#@ if stemcell.version == "170.x":
- name: agent-170.x
  jobs:
  - test-unit-bosh-agent-170.x
  - test-integration-bosh-agent-170.x
  - promote-bosh-agent-170.x
#@ end
#@ if stemcell.version == "250.x":
- name: agent-250.x
  jobs:
  - test-unit-bosh-agent-250.x
  - test-integration-bosh-agent-250.x
  - bosh-integration-tests-bosh-agent-250.x
  - promote-bosh-agent-250.x
#@ end
#@ if stemcell.version == "315.x":
- name: agent-315.x
  jobs:
  - test-unit-bosh-agent-315.x
  - test-integration-bosh-agent-315.x
  - bosh-integration-tests-bosh-agent-315.x
  - promote-bosh-agent-315.x
#@ end
#@ end
- name: manual-triggers
  jobs:
#@ for stemcell in data.values.stemcells:
  - manual-trigger-(@= stemcell.version @)
#@ end
- name: automatic-triggers
  jobs:
#@ for stemcell in data.values.stemcells:
  - create-story-(@= stemcell.version @)
  - create-story-usn-(@= stemcell.version @)
  - log-low-medium-cves-(@= stemcell.version @)
#@ if stemcell.version == "master":
  - notify-of-usn
#@ end
#@ end

jobs:
#@ for stemcell in data.values.stemcells:
- name: manual-trigger-(@= stemcell.version @)
  plan:
  - get: bosh-stemcells-ci
  - file: bosh-stemcells-ci/tasks/write-bump-message.yml
    params:
      MESSAGE_PREFIX: Manual bump
    task: write-message
  - params:
      file: message/message.txt
    put: stemcell-trigger-(@= stemcell.version @)

- name: create-story-(@= stemcell.version @)
  plan:
  - in_parallel:
    - get: every-2-weeks-on-monday
      trigger: true
    - get: bosh-stemcells-ci
    - get: bosh-linux-stemcell-builder
      resource: bosh-linux-stemcell-builder-(@= stemcell.version @)
  - file: bosh-stemcells-ci/tasks/create-story.yml
    params:
      #@ if stemcell.version == "master":
      BRANCH: ubuntu-xenial/(@= stemcell.branch @)
      #@ else:
      BRANCH: (@= stemcell.branch @)
      #@ end
      DESCRIPTION: periodic bump
      PROJECT_ID: ((story_creator_tracker_project_id))
      TOKEN: ((story_creator_tracker_token))
    task: create-story
  - file: bosh-stemcells-ci/tasks/write-bump-message.yml
    params:
      MESSAGE_PREFIX: Periodic bump
    task: write-message
  - params:
      file: message/message.txt
    put: stemcell-trigger-(@= stemcell.version @)

- name: stemcell-trigger-start-(@= stemcell.version @)
  plan:
  - in_parallel:
    - get: usn-log-(@= stemcell.version @)
    - get: stemcell-trigger-(@= stemcell.version @)
      trigger: true

- name: create-story-usn-(@= stemcell.version @)
  serial_groups: [log-cves-(@= stemcell.version @)]
  plan:
  - in_parallel:
    - get: bosh-stemcells-ci
    - get: bosh-linux-stemcell-builder
      resource: bosh-linux-stemcell-builder-(@= stemcell.version @)
    - get: xenial-usn
      trigger: true
    - get: usn-log-(@= stemcell.version @)
  - file: bosh-stemcells-ci/tasks/write-usn-message.yml
    input_mapping:
      usn-log-in: usn-log-(@= stemcell.version @)
      usn-source: xenial-usn
    task: commit-usn-information
  - file: bosh-stemcells-ci/tasks/create-story.yml
    params:
      #@ if stemcell.version == "master":
      BRANCH: ubuntu-xenial/(@= stemcell.branch @)
      #@ else:
      BRANCH: (@= stemcell.branch @)
      #@ end
      DESCRIPTION: ubuntu *security* notice
      PROJECT_ID: ((story_creator_private_tracker_project_id))
      TOKEN: ((story_creator_tracker_token))
    task: create-story
  - file: bosh-stemcells-ci/tasks/write-bump-message.yml
    params:
      MESSAGE_PREFIX: Addresses
    task: write-message
  - params:
      file: message/message.txt
    put: stemcell-trigger-(@= stemcell.version @)
  - params:
      acl: public-read
      file: usn-log-out/usn-log.json
    put: usn-log-(@= stemcell.version @)

- name: log-low-medium-cves-(@= stemcell.version @)
  serial_groups: [log-cves-(@= stemcell.version @)]
  plan:
  - in_parallel:
    - get: bosh-stemcells-ci
    - get: xenial-usn-low-medium
      trigger: true
    - get: usn-log-(@= stemcell.version @)
  - task: commit-usn-information
    file: bosh-stemcells-ci/tasks/write-usn-message.yml
    input_mapping:
      usn-source: xenial-usn-low-medium
      usn-log-in: usn-log-(@= stemcell.version @)
  - put: usn-log-(@= stemcell.version @)
    params:
      file: usn-log-out/usn-log.json
      acl: public-read

- name: build-os-image-(@= stemcell.version @)
  plan:
  - get: bosh-stemcells-ci
  - get: bosh-linux-stemcell-builder
    resource: bosh-linux-stemcell-builder-(@= stemcell.version @)
  - get: version
    params:
      bump: "major"
    resource: os-image-version-(@= stemcell.version @)
  - get: usn-log-(@= stemcell.version @)
    passed:
    - stemcell-trigger-start-(@= stemcell.version @)
  - get: stemcell-trigger-(@= stemcell.version @)
    passed:
    - stemcell-trigger-start-(@= stemcell.version @)
    trigger: true
  - file: bosh-stemcells-ci/tasks/os-images/build.yml
    params:
      OPERATING_SYSTEM_NAME: ubuntu
      OPERATING_SYSTEM_VERSION: xenial
    privileged: true
    task: build
  - params:
      files:
      - os-image/ubuntu-xenial.tgz
      - usn-log-(@= stemcell.version @)/usn-log.json
      rename: ubuntu-xenial.meta4
      options:
        author_email: ci@localhost
        author_name: CI Bot
        message: 'bump OS image'
      version: version/version
    put: os-image-tarball-(@= stemcell.version @)
  - params:
      file: version/number
    put: os-image-version-(@= stemcell.version @)

- name: test-unit-(@= stemcell.version @)
  plan:
  - get: bosh-stemcells-ci
  - get: bosh-linux-stemcell-builder
    resource: bosh-linux-stemcell-builder-(@= stemcell.version @)
    trigger: true
  - get: stemcell-trigger-(@= stemcell.version @)
    passed:
    - build-os-image-(@= stemcell.version @)
    trigger: true
  - file: bosh-stemcells-ci/tasks/test-unit.yml
    task: test-unit
  serial: true

- name: build-stemcell-(@= stemcell.version @)
  plan:
  - get: bosh-stemcells-ci
  - get: bosh-linux-stemcell-builder
    passed:
    - test-unit-(@= stemcell.version @)
    resource: bosh-linux-stemcell-builder-(@= stemcell.version @)
    trigger: true
  - get: stemcell-trigger-(@= stemcell.version @)
    passed:
    - test-unit-(@= stemcell.version @)
    trigger: true
  - get: version
    params:
      bump: (@= stemcell.bump_version @)
    resource: version-(@= stemcell.version @)
  - params:
      file: version/number
    put: version-(@= stemcell.version @)
  serial: true

- name: repack-stemcell-vsphere-esxi-(@= stemcell.version @)
  plan:
  - in_parallel:
    - get: version
      passed:
      - build-vsphere-esxi-(@= stemcell.version @)
      resource: version-(@= stemcell.version @)
      trigger: true
    - get: stemcell-trigger-(@= stemcell.version @)
      passed:
      - build-vsphere-esxi-(@= stemcell.version @)
      trigger: true
    - get: bosh-linux-stemcell-builder
      resource: bosh-linux-stemcell-builder-(@= stemcell.version @)
    - get: bosh-agent
      resource: bosh-agent-(@= stemcell.version @)
#@ if stemcell.version == "master":
      passed:
      - promote-bosh-agent-develop
#@ elif stemcell.version == "97.x":
      passed:
      - promote-bosh-agent-97.x
#@ elif stemcell.version == "170.x":
      passed:
      - promote-bosh-agent-170.x
#@ elif stemcell.version == "250.x":
      passed:
      - promote-bosh-agent-250.x
#@ elif stemcell.version == "315.x":
      passed:
      - promote-bosh-agent-315.x
#@ end
      trigger: true
    - get: stemcell
      passed:
      - build-vsphere-esxi-(@= stemcell.version @)
      resource: vsphere-esxi-(@= stemcell.version @)
      tags:
      - vsphere-v6.5
    - get: bosh-stemcells-ci
  - task: repack-stemcell
    privileged: true
    file: bosh-stemcells-ci/pipelines/repack-pipeline/repack-stemcell-vsphere.yml
  - in_parallel:
    - attempts: 3
      params:
        files:
        - repacked-stemcell/*.tgz
        rename: "{{.Version}}/vsphere-esxi-go_agent.meta4"
        options:
          author_email: ci@localhost
          author_name: CI Bot
          message: 'dev: ubuntu-xenial'
        version: version-number/number
      put: vsphere-esxi-(@= stemcell.version @)

- name: repack-stemcell-vcloud-esxi-(@= stemcell.version @)
  plan:
  - in_parallel:
    - get: version
      passed:
      - build-vcloud-esxi-(@= stemcell.version @)
      resource: version-(@= stemcell.version @)
      trigger: true
    - get: stemcell-trigger-(@= stemcell.version @)
      passed:
      - build-vcloud-esxi-(@= stemcell.version @)
      trigger: true
    - get: bosh-linux-stemcell-builder
      resource: bosh-linux-stemcell-builder-(@= stemcell.version @)
    - get: bosh-agent
      resource: bosh-agent-(@= stemcell.version @)
#@ if stemcell.version == "master":
      passed:
      - promote-bosh-agent-develop
#@ elif stemcell.version == "97.x":
      passed:
      - promote-bosh-agent-97.x
#@ elif stemcell.version == "170.x":
      passed:
      - promote-bosh-agent-170.x
#@ elif stemcell.version == "250.x":
      passed:
      - promote-bosh-agent-250.x
#@ elif stemcell.version == "315.x":
      passed:
      - promote-bosh-agent-315.x
#@ end
      trigger: true
    - get: stemcell
      passed:
      - build-vcloud-esxi-(@= stemcell.version @)
      resource: vcloud-esxi-(@= stemcell.version @)
      tags:
      - vsphere-v6.5
    - get: bosh-stemcells-ci
  - task: repack-stemcell
    privileged: true
    file: bosh-stemcells-ci/pipelines/repack-pipeline/repack-stemcell-vsphere.yml
  - in_parallel:
    - attempts: 3
      params:
        files:
        - repacked-stemcell/*.tgz
        rename: "{{.Version}}/vcloud-esxi-go_agent.meta4"
        options:
          author_email: ci@localhost
          author_name: CI Bot
          message: 'dev: ubuntu-xenial'
        version: version-number/number
      put: vcloud-esxi-(@= stemcell.version @)

- name: repack-stemcell-openstack-kvm-(@= stemcell.version @)
  plan:
  - in_parallel:
    - get: version
      passed:
      - build-openstack-kvm-(@= stemcell.version @)
      resource: version-(@= stemcell.version @)
      trigger: true
    - get: stemcell-trigger-(@= stemcell.version @)
      passed:
      - build-openstack-kvm-(@= stemcell.version @)
      trigger: true
    - get: bosh-linux-stemcell-builder
      resource: bosh-linux-stemcell-builder-(@= stemcell.version @)
    - get: bosh-agent
      resource: bosh-agent-(@= stemcell.version @)
#@ if stemcell.version == "master":
      passed:
      - promote-bosh-agent-develop
#@ elif stemcell.version == "97.x":
      passed:
      - promote-bosh-agent-97.x
#@ elif stemcell.version == "170.x":
      passed:
      - promote-bosh-agent-170.x
#@ elif stemcell.version == "250.x":
      passed:
      - promote-bosh-agent-250.x
#@ elif stemcell.version == "315.x":
      passed:
      - promote-bosh-agent-315.x
#@ end
      trigger: true
    - get: stemcell
      passed:
      - build-openstack-kvm-(@= stemcell.version @)
      resource: openstack-kvm-(@= stemcell.version @)
      params:
        include_files:
        - "bosh-stemcell-*-openstack-kvm-ubuntu-xenial-go_agent.tgz"
    - get: bosh-stemcells-ci
  - task: repack-stemcell
    privileged: true
    file: bosh-stemcells-ci/pipelines/repack-pipeline/repack-stemcell-openstack.yml
  - in_parallel:
    - attempts: 3
      params:
        files:
        - repacked-stemcell/*.tgz
        rename: "{{.Version}}/openstack-kvm-go_agent.meta4"
        options:
          author_email: ci@localhost
          author_name: CI Bot
          message: 'dev: ubuntu-xenial'
        version: version-number/number
      put: openstack-kvm-(@= stemcell.version @)

- name: repack-stemcell-google-kvm-(@= stemcell.version @)
  plan:
  - in_parallel:
    - get: version
      passed:
      - build-google-kvm-(@= stemcell.version @)
      resource: version-(@= stemcell.version @)
      trigger: true
    - get: stemcell-trigger-(@= stemcell.version @)
      passed:
      - build-google-kvm-(@= stemcell.version @)
      trigger: true
    - get: bosh-linux-stemcell-builder
      resource: bosh-linux-stemcell-builder-(@= stemcell.version @)
    - get: bosh-agent
      resource: bosh-agent-(@= stemcell.version @)
#@ if stemcell.version == "master":
      passed:
      - promote-bosh-agent-develop
#@ elif stemcell.version == "97.x":
      passed:
      - promote-bosh-agent-97.x
#@ elif stemcell.version == "170.x":
      passed:
      - promote-bosh-agent-170.x
#@ elif stemcell.version == "170.x":
      passed:
      - promote-bosh-agent-170.x
#@ elif stemcell.version == "250.x":
      passed:
      - promote-bosh-agent-250.x
#@ elif stemcell.version == "315.x":
      passed:
      - promote-bosh-agent-315.x
#@ end
      trigger: true
    - get: stemcell
      passed:
      - build-google-kvm-(@= stemcell.version @)
      resource: google-kvm-(@= stemcell.version @)
    - get: bosh-stemcells-ci
  - task: repack-stemcell
    privileged: true
    file: bosh-stemcells-ci/pipelines/repack-pipeline/repack-stemcell-gcp.yml
  - in_parallel:
    - attempts: 3
      params:
        files:
        - repacked-stemcell/*.tgz
        rename: "{{.Version}}/google-kvm-go_agent.meta4"
        options:
          author_email: ci@localhost
          author_name: CI Bot
          message: 'dev: ubuntu-xenial'
        version: version-number/number
      put: google-kvm-(@= stemcell.version @)

- name: repack-stemcell-azure-hyperv-(@= stemcell.version @)
  plan:
  - in_parallel:
    - get: version
      passed:
      - build-azure-hyperv-(@= stemcell.version @)
      resource: version-(@= stemcell.version @)
      trigger: true
    - get: stemcell-trigger-(@= stemcell.version @)
      passed:
      - build-azure-hyperv-(@= stemcell.version @)
      trigger: true
    - get: bosh-linux-stemcell-builder
      resource: bosh-linux-stemcell-builder-(@= stemcell.version @)
    - get: bosh-agent
      resource: bosh-agent-(@= stemcell.version @)
#@ if stemcell.version == "master":
      passed:
      - promote-bosh-agent-develop
#@ elif stemcell.version == "97.x":
      passed:
      - promote-bosh-agent-97.x
#@ elif stemcell.version == "170.x":
      passed:
      - promote-bosh-agent-170.x
#@ elif stemcell.version == "250.x":
      passed:
      - promote-bosh-agent-250.x
#@ elif stemcell.version == "315.x":
      passed:
      - promote-bosh-agent-315.x
#@ end
      trigger: true
    - get: stemcell
      passed:
      - build-azure-hyperv-(@= stemcell.version @)
      resource: azure-hyperv-(@= stemcell.version @)
    - get: bosh-stemcells-ci
  - task: repack-stemcell
    privileged: true
    file: bosh-stemcells-ci/pipelines/repack-pipeline/repack-stemcell-azure.yml
  - in_parallel:
    - attempts: 3
      params:
        files:
        - repacked-stemcell/*.tgz
        rename: "{{.Version}}/azure-hyperv-go_agent.meta4"
        options:
          author_email: ci@localhost
          author_name: CI Bot
          message: 'dev: ubuntu-xenial'
        version: version-number/number
      put: azure-hyperv-(@= stemcell.version @)

- name: repack-stemcell-aws-xen-hvm-(@= stemcell.version @)
  plan:
  - in_parallel:
    - get: version
      passed:
      - build-aws-xen-hvm-(@= stemcell.version @)
      resource: version-(@= stemcell.version @)
      trigger: true
    - get: stemcell-trigger-(@= stemcell.version @)
      passed:
      - build-aws-xen-hvm-(@= stemcell.version @)
      trigger: true
    - get: bosh-linux-stemcell-builder
      resource: bosh-linux-stemcell-builder-(@= stemcell.version @)
    - get: bosh-agent
#@ if stemcell.version == "master":
      passed:
      - promote-bosh-agent-develop
#@ elif stemcell.version == "97.x":
      passed:
      - promote-bosh-agent-97.x
#@ elif stemcell.version == "170.x":
      passed:
      - promote-bosh-agent-170.x
#@ elif stemcell.version == "250.x":
      passed:
      - promote-bosh-agent-250.x
#@ elif stemcell.version == "315.x":
      passed:
      - promote-bosh-agent-315.x
#@ end
      resource: bosh-agent-(@= stemcell.version @)
      trigger: true
    - get: stemcell
      passed:
      - build-aws-xen-hvm-(@= stemcell.version @)
      resource: aws-xen-hvm-(@= stemcell.version @)
    - get: bosh-stemcells-ci
  - task: repack-stemcell
    privileged: true
    file: bosh-stemcells-ci/pipelines/repack-pipeline/repack-stemcell-aws.yml
  - in_parallel:
    - attempts: 3
      params:
        files:
        - repacked-stemcell/*.tgz
        rename: "{{.Version}}/aws-xen-hvm-go_agent.meta4"
        options:
          author_email: ci@localhost
          author_name: CI Bot
          message: 'dev: ubuntu-xenial'
        version: version-number/number
      put: aws-xen-hvm-(@= stemcell.version @)

- name: repack-stemcell-warden-boshlite-(@= stemcell.version @)
  plan:
  - in_parallel:
    - get: version
      passed:
      - build-warden-boshlite-(@= stemcell.version @)
      resource: version-(@= stemcell.version @)
      trigger: true
    - get: stemcell-trigger-(@= stemcell.version @)
      passed:
      - build-warden-boshlite-(@= stemcell.version @)
      trigger: true
    - get: bosh-linux-stemcell-builder
      resource: bosh-linux-stemcell-builder-(@= stemcell.version @)
    - get: bosh-agent
#@ if stemcell.version == "master":
      passed:
      - promote-bosh-agent-develop
#@ elif stemcell.version == "97.x":
      passed:
      - promote-bosh-agent-97.x
#@ elif stemcell.version == "170.x":
      passed:
      - promote-bosh-agent-170.x
#@ elif stemcell.version == "250.x":
      passed:
      - promote-bosh-agent-250.x
#@ elif stemcell.version == "315.x":
      passed:
      - promote-bosh-agent-315.x
#@ end
      resource: bosh-agent-(@= stemcell.version @)
      trigger: true
    - get: stemcell
      passed:
      - build-warden-boshlite-(@= stemcell.version @)
      resource: warden-boshlite-(@= stemcell.version @)
    - get: bosh-stemcells-ci
  - task: repack-stemcell
    privileged: true
    file: bosh-stemcells-ci/pipelines/repack-pipeline/repack-stemcell-warden.yml
  - in_parallel:
    - attempts: 3
      params:
        files:
        - repacked-stemcell/*.tgz
        rename: "{{.Version}}/warden-boshlite-go_agent.meta4"
        options:
          author_email: ci@localhost
          author_name: CI Bot
          message: 'dev: ubuntu-xenial'
        version: version-number/number
      put: warden-boshlite-(@= stemcell.version @)

#@ if stemcell.include_alicloud:
- name: repack-stemcell-alicloud-kvm-(@= stemcell.version @)
  plan:
  - in_parallel:
    - get: version
      passed:
      - build-alicloud-kvm-(@= stemcell.version @)
      resource: version-(@= stemcell.version @)
      trigger: true
    - get: stemcell-trigger-(@= stemcell.version @)
      passed:
      - build-alicloud-kvm-(@= stemcell.version @)
      trigger: true
    - get: bosh-linux-stemcell-builder
      resource: bosh-linux-stemcell-builder-(@= stemcell.version @)
    - get: bosh-agent
      resource: bosh-agent-(@= stemcell.version @)
#@ if stemcell.version == "master":
      passed:
      - promote-bosh-agent-develop
#@ elif stemcell.version == "97.x":
      passed:
      - promote-bosh-agent-97.x
#@ elif stemcell.version == "170.x":
      passed:
      - promote-bosh-agent-170.x
#@ elif stemcell.version == "250.x":
      passed:
      - promote-bosh-agent-250.x
#@ elif stemcell.version == "315.x":
      passed:
      - promote-bosh-agent-315.x
#@ end
      trigger: true
    - get: stemcell
      passed:
      - build-alicloud-kvm-(@= stemcell.version @)
      resource: alicloud-kvm-(@= stemcell.version @)
    - get: bosh-stemcells-ci
  - task: repack-stemcell
    privileged: true
    file: bosh-stemcells-ci/pipelines/repack-pipeline/repack-stemcell-openstack-raw.yml
  - in_parallel:
    - attempts: 3
      params:
        files:
        - repacked-stemcell/*.tgz
        rename: "{{.Version}}/alicloud-kvm-go_agent.meta4"
        options:
          author_email: ci@localhost
          author_name: CI Bot
          message: 'dev: ubuntu-xenial'
        version: version-number/number
      put: alicloud-kvm-(@= stemcell.version @)
#@ end

- name: repack-stemcell-openstack-kvm-raw-(@= stemcell.version @)
  plan:
  - in_parallel:
    - get: version
      passed:
      - build-openstack-kvm-(@= stemcell.version @)
      resource: version-(@= stemcell.version @)
      trigger: true
    - get: stemcell-trigger-(@= stemcell.version @)
      passed:
      - build-openstack-kvm-(@= stemcell.version @)
      trigger: true
    - get: bosh-linux-stemcell-builder
      resource: bosh-linux-stemcell-builder-(@= stemcell.version @)
    - get: bosh-agent
#@ if stemcell.version == "master":
      passed:
      - promote-bosh-agent-develop
#@ elif stemcell.version == "97.x":
      passed:
      - promote-bosh-agent-97.x
#@ elif stemcell.version == "170.x":
      passed:
      - promote-bosh-agent-170.x
#@ elif stemcell.version == "250.x":
      passed:
      - promote-bosh-agent-250.x
#@ elif stemcell.version == "315.x":
      passed:
      - promote-bosh-agent-315.x
#@ end
      resource: bosh-agent-(@= stemcell.version @)
      trigger: true
    - get: stemcell
      passed:
      - build-openstack-kvm-(@= stemcell.version @)
      resource: openstack-kvm-(@= stemcell.version @)
      params:
        include_files:
        - "bosh-stemcell-*-openstack-kvm-ubuntu-xenial-go_agent-raw.tgz"
    - get: bosh-stemcells-ci
  - task: repack-stemcell
    privileged: true
    file: bosh-stemcells-ci/pipelines/repack-pipeline/repack-stemcell-openstack-raw.yml
  - in_parallel:
    - attempts: 3
      params:
        files:
        - repacked-stemcell/*.tgz
        rename: "{{.Version}}/openstack-kvm-go_agent.meta4"
        options:
          author_email: ci@localhost
          author_name: CI Bot
          message: 'dev: ubuntu-xenial'
        version: version-number/number
      put: openstack-kvm-(@= stemcell.version @)

- name: test-stemcells-(@= stemcell.version @)
  plan:
  - do:
    - in_parallel:
      - get: version
        passed:
        - repack-stemcell-warden-boshlite-(@= stemcell.version @)
        - repack-stemcell-aws-xen-hvm-(@= stemcell.version @)
        - repack-stemcell-azure-hyperv-(@= stemcell.version @)
        - repack-stemcell-google-kvm-(@= stemcell.version @)
        - repack-stemcell-openstack-kvm-(@= stemcell.version @)
        - repack-stemcell-openstack-kvm-raw-(@= stemcell.version @)
        - repack-stemcell-vsphere-esxi-(@= stemcell.version @)
        - repack-stemcell-vcloud-esxi-(@= stemcell.version @)
        resource: version-(@= stemcell.version @)
        trigger: true
      - get: bosh-stemcells-ci
      - get: bosh-agent
        resource: bosh-agent-(@= stemcell.version @)
        passed:
        - repack-stemcell-warden-boshlite-(@= stemcell.version @)
        - repack-stemcell-aws-xen-hvm-(@= stemcell.version @)
        - repack-stemcell-azure-hyperv-(@= stemcell.version @)
        - repack-stemcell-google-kvm-(@= stemcell.version @)
        - repack-stemcell-openstack-kvm-(@= stemcell.version @)
        - repack-stemcell-openstack-kvm-raw-(@= stemcell.version @)
        - repack-stemcell-vsphere-esxi-(@= stemcell.version @)
        - repack-stemcell-vcloud-esxi-(@= stemcell.version @)
        trigger: true
      - get: bosh-linux-stemcell-builder
        resource: bosh-linux-stemcell-builder-(@= stemcell.version @)
      - get: bosh-deployment
      - get: bosh-cli
      - get: syslog-release
      - get: os-conf-release
      - get: stemcell
        passed:
        - repack-stemcell-vsphere-esxi-(@= stemcell.version @)
        resource: vsphere-esxi-(@= stemcell.version @)
        tags:
        - vsphere-v6.5
      - get: stemcell-trigger-(@= stemcell.version @)
        passed:
        - repack-stemcell-warden-boshlite-(@= stemcell.version @)
        - repack-stemcell-aws-xen-hvm-(@= stemcell.version @)
        - repack-stemcell-azure-hyperv-(@= stemcell.version @)
        - repack-stemcell-google-kvm-(@= stemcell.version @)
        - repack-stemcell-openstack-kvm-(@= stemcell.version @)
        - repack-stemcell-openstack-kvm-raw-(@= stemcell.version @)
        - repack-stemcell-vsphere-esxi-(@= stemcell.version @)
        - repack-stemcell-vcloud-esxi-(@= stemcell.version @)
        trigger: true
    - params:
        acquire: true
      put: environment
    - do:
      - file: bosh-stemcells-ci/tasks/deploy-director.yml
        params:
          BOSH_vcenter_cluster: ((vcenter-cluster))
          BOSH_vcenter_dc: ((vcenter-dc))
          BOSH_vcenter_disks: ((vcenter-disk-path))
          BOSH_vcenter_ds: ((vcenter-datastore))
          BOSH_vcenter_ip: ((vcenter-ip))
          BOSH_vcenter_password: ((vcenter-password))
          BOSH_vcenter_rp: ((vcenter-rp))
          BOSH_vcenter_templates: ((vcenter-template-folder))
          BOSH_vcenter_user: ((vcenter-user))
          BOSH_vcenter_vms: ((vcenter-vm-folder))
        tags:
        - vsphere-v6.5
        task: deploy-director
      - attempts: 3
        file: bosh-stemcells-ci/tasks/test-stemcell.yml
        params:
          BOSH_os_name: ubuntu-xenial
          package: ipv4director
        tags:
        - vsphere-v6.5
        task: test-stemcell
      ensure:
        file: bosh-stemcells-ci/tasks/teardown.yml
        tags:
        - vsphere-v6.5
        task: teardown
    ensure:
      params:
        release: environment
      put: environment
  serial: true

- name: build-warden-boshlite-(@= stemcell.version @)
  plan:
  - in_parallel:
    - get: version
      passed:
      - build-stemcell-(@= stemcell.version @)
      resource: version-(@= stemcell.version @)
      trigger: true
    - get: bosh-stemcells-ci
    - get: stemcell-trigger-(@= stemcell.version @)
      passed:
      - build-stemcell-(@= stemcell.version @)
      trigger: true
    - get: bosh-linux-stemcell-builder
      passed:
      - build-stemcell-(@= stemcell.version @)
      resource: bosh-linux-stemcell-builder-(@= stemcell.version @)
    - get: stemcells-index
    - get: os-image-tarball
      resource: os-image-tarball-(@= stemcell.version @)
      passed:
      - build-os-image-(@= stemcell.version @)
  - attempts: 3
    file: bosh-stemcells-ci/tasks/build.yml
    params:
      HYPERVISOR: boshlite
      IAAS: warden
      OS_NAME: ubuntu
      OS_VERSION: xenial
      STEMCELL_BUCKET: bosh-core-stemcells-candidate
    privileged: true
    task: create-stemcell
  - in_parallel:
    - attempts: 3
      params:
        files:
        - stemcell/*.tgz
        rename: "{{.Version}}/warden-boshlite-go_agent.meta4"
        options:
          author_email: ci@localhost
          author_name: CI Bot
          message: 'dev: ubuntu-xenial'
        version: candidate-build-number/number
      put: warden-boshlite-(@= stemcell.version @)

- name: build-aws-xen-hvm-(@= stemcell.version @)
  plan:
  - in_parallel:
    - get: version
      passed:
      - build-stemcell-(@= stemcell.version @)
      resource: version-(@= stemcell.version @)
      trigger: true
    - get: bosh-stemcells-ci
    - get: stemcell-trigger-(@= stemcell.version @)
      passed:
      - build-stemcell-(@= stemcell.version @)
      trigger: true
    - get: bosh-linux-stemcell-builder
      passed:
      - build-stemcell-(@= stemcell.version @)
      resource: bosh-linux-stemcell-builder-(@= stemcell.version @)
    - get: stemcells-index
    - get: os-image-tarball
      resource: os-image-tarball-(@= stemcell.version @)
      passed:
      - build-os-image-(@= stemcell.version @)
  - attempts: 3
    file: bosh-stemcells-ci/tasks/build.yml
    params:
      HYPERVISOR: xen-hvm
      IAAS: aws
      OS_NAME: ubuntu
      OS_VERSION: xenial
      STEMCELL_BUCKET: bosh-core-stemcells-candidate
    privileged: true
    task: create-stemcell
  - in_parallel:
    - attempts: 3
      params:
        files:
        - stemcell/*.tgz
        rename: "{{.Version}}/aws-xen-hvm-go_agent.meta4"
        options:
          author_email: ci@localhost
          author_name: CI Bot
          message: 'dev: ubuntu-xenial'
        version: candidate-build-number/number
      put: aws-xen-hvm-(@= stemcell.version @)

- name: build-azure-hyperv-(@= stemcell.version @)
  plan:
  - in_parallel:
    - get: version
      passed:
      - build-stemcell-(@= stemcell.version @)
      resource: version-(@= stemcell.version @)
      trigger: true
    - get: bosh-stemcells-ci
    - get: stemcell-trigger-(@= stemcell.version @)
      passed:
      - build-stemcell-(@= stemcell.version @)
      trigger: true
    - get: bosh-linux-stemcell-builder
      passed:
      - build-stemcell-(@= stemcell.version @)
      resource: bosh-linux-stemcell-builder-(@= stemcell.version @)
    - get: stemcells-index
    - get: os-image-tarball
      resource: os-image-tarball-(@= stemcell.version @)
      passed:
      - build-os-image-(@= stemcell.version @)
  - attempts: 3
    file: bosh-stemcells-ci/tasks/build.yml
    params:
      HYPERVISOR: hyperv
      IAAS: azure
      OS_NAME: ubuntu
      OS_VERSION: xenial
      STEMCELL_BUCKET: bosh-core-stemcells-candidate
    privileged: true
    task: create-stemcell
  - in_parallel:
    - attempts: 3
      params:
        files:
        - stemcell/*.tgz
        rename: "{{.Version}}/azure-hyperv-go_agent.meta4"
        options:
          author_email: ci@localhost
          author_name: CI Bot
          message: 'dev: ubuntu-xenial'
        version: candidate-build-number/number
      put: azure-hyperv-(@= stemcell.version @)

- name: build-google-kvm-(@= stemcell.version @)
  plan:
  - in_parallel:
    - get: version
      passed:
      - build-stemcell-(@= stemcell.version @)
      resource: version-(@= stemcell.version @)
      trigger: true
    - get: bosh-stemcells-ci
    - get: stemcell-trigger-(@= stemcell.version @)
      passed:
      - build-stemcell-(@= stemcell.version @)
      trigger: true
    - get: bosh-linux-stemcell-builder
      passed:
      - build-stemcell-(@= stemcell.version @)
      resource: bosh-linux-stemcell-builder-(@= stemcell.version @)
    - get: stemcells-index
    - get: os-image-tarball
      resource: os-image-tarball-(@= stemcell.version @)
      passed:
      - build-os-image-(@= stemcell.version @)
  - attempts: 3
    file: bosh-stemcells-ci/tasks/build.yml
    params:
      HYPERVISOR: kvm
      IAAS: google
      OS_NAME: ubuntu
      OS_VERSION: xenial
      STEMCELL_BUCKET: bosh-core-stemcells-candidate
    privileged: true
    task: create-stemcell
  - in_parallel:
    - attempts: 3
      params:
        files:
        - stemcell/*.tgz
        rename: "{{.Version}}/google-kvm-go_agent.meta4"
        options:
          author_email: ci@localhost
          author_name: CI Bot
          message: 'dev: ubuntu-xenial'
        version: candidate-build-number/number
      put: google-kvm-(@= stemcell.version @)

- name: build-openstack-kvm-(@= stemcell.version @)
  plan:
  - in_parallel:
    - get: version
      passed:
      - build-stemcell-(@= stemcell.version @)
      resource: version-(@= stemcell.version @)
      trigger: true
    - get: bosh-stemcells-ci
    - get: stemcell-trigger-(@= stemcell.version @)
      passed:
      - build-stemcell-(@= stemcell.version @)
      trigger: true
    - get: bosh-linux-stemcell-builder
      passed:
      - build-stemcell-(@= stemcell.version @)
      resource: bosh-linux-stemcell-builder-(@= stemcell.version @)
    - get: stemcells-index
    - get: os-image-tarball
      resource: os-image-tarball-(@= stemcell.version @)
      passed:
      - build-os-image-(@= stemcell.version @)
  - attempts: 3
    file: bosh-stemcells-ci/tasks/build.yml
    params:
      HYPERVISOR: kvm
      IAAS: openstack
      OS_NAME: ubuntu
      OS_VERSION: xenial
      STEMCELL_BUCKET: bosh-core-stemcells-candidate
    privileged: true
    task: create-stemcell
  - in_parallel:
    - attempts: 3
      params:
        files:
        - stemcell/*.tgz
        rename: "{{.Version}}/openstack-kvm-go_agent.meta4"
        options:
          author_email: ci@localhost
          author_name: CI Bot
          message: 'dev: ubuntu-xenial'
        version: candidate-build-number/number
      put: openstack-kvm-(@= stemcell.version @)

- name: build-vsphere-esxi-(@= stemcell.version @)
  plan:
  - in_parallel:
    - get: version
      passed:
      - build-stemcell-(@= stemcell.version @)
      resource: version-(@= stemcell.version @)
      trigger: true
    - get: bosh-stemcells-ci
    - get: stemcell-trigger-(@= stemcell.version @)
      passed:
      - build-stemcell-(@= stemcell.version @)
      trigger: true
    - get: bosh-linux-stemcell-builder
      passed:
      - build-stemcell-(@= stemcell.version @)
      resource: bosh-linux-stemcell-builder-(@= stemcell.version @)
    - get: stemcells-index
    - get: os-image-tarball
      resource: os-image-tarball-(@= stemcell.version @)
      passed:
      - build-os-image-(@= stemcell.version @)
  - attempts: 3
    file: bosh-stemcells-ci/tasks/build.yml
    params:
      HYPERVISOR: esxi
      IAAS: vsphere
      OS_NAME: ubuntu
      OS_VERSION: xenial
      STEMCELL_BUCKET: bosh-core-stemcells-candidate
    privileged: true
    task: create-stemcell
  - in_parallel:
    - attempts: 3
      params:
        files:
        - stemcell/*.tgz
        rename: "{{.Version}}/vsphere-esxi-go_agent.meta4"
        options:
          author_email: ci@localhost
          author_name: CI Bot
          message: 'dev: ubuntu-xenial'
        version: candidate-build-number/number
      put: vsphere-esxi-(@= stemcell.version @)

- name: build-vcloud-esxi-(@= stemcell.version @)
  plan:
  - in_parallel:
    - get: version
      passed:
      - build-stemcell-(@= stemcell.version @)
      resource: version-(@= stemcell.version @)
      trigger: true
    - get: bosh-stemcells-ci
    - get: stemcell-trigger-(@= stemcell.version @)
      passed:
      - build-stemcell-(@= stemcell.version @)
      trigger: true
    - get: bosh-linux-stemcell-builder
      passed:
      - build-stemcell-(@= stemcell.version @)
      resource: bosh-linux-stemcell-builder-(@= stemcell.version @)
    - get: stemcells-index
    - get: os-image-tarball
      resource: os-image-tarball-(@= stemcell.version @)
      passed:
      - build-os-image-(@= stemcell.version @)
  - attempts: 3
    file: bosh-stemcells-ci/tasks/build.yml
    params:
      HYPERVISOR: esxi
      IAAS: vcloud
      OS_NAME: ubuntu
      OS_VERSION: xenial
      STEMCELL_BUCKET: bosh-core-stemcells-candidate
    privileged: true
    task: create-stemcell
  - in_parallel:
    - attempts: 3
      params:
        files:
        - stemcell/*.tgz
        rename: "{{.Version}}/vcloud-esxi-go_agent.meta4"
        options:
          author_email: ci@localhost
          author_name: CI Bot
          message: 'dev: ubuntu-xenial'
        version: candidate-build-number/number
      put: vcloud-esxi-(@= stemcell.version @)

#@ if stemcell.include_alicloud:
- name: build-alicloud-kvm-(@= stemcell.version @)
  plan:
  - in_parallel:
    - get: version
      passed:
      - build-stemcell-(@= stemcell.version @)
      resource: version-(@= stemcell.version @)
      trigger: true
    - get: bosh-stemcells-ci
    - get: stemcell-trigger-(@= stemcell.version @)
      passed:
      - build-stemcell-(@= stemcell.version @)
      trigger: true
    - get: bosh-linux-stemcell-builder
      passed:
      - build-stemcell-(@= stemcell.version @)
      resource: bosh-linux-stemcell-builder-(@= stemcell.version @)
    - get: stemcells-index
    - get: os-image-tarball
      resource: os-image-tarball-(@= stemcell.version @)
      passed:
      - build-os-image-(@= stemcell.version @)
  - attempts: 3
    file: bosh-stemcells-ci/tasks/build.yml
    params:
      HYPERVISOR: kvm
      IAAS: alicloud
      OS_NAME: ubuntu
      OS_VERSION: xenial
      STEMCELL_BUCKET: bosh-core-stemcells-candidate
    privileged: true
    task: create-stemcell
  - in_parallel:
    - attempts: 3
      params:
        files:
        - stemcell/*.tgz
        rename: "{{.Version}}/alicloud-kvm-go_agent.meta4"
        options:
          author_email: ci@localhost
          author_name: CI Bot
          message: 'dev: ubuntu-xenial'
        version: candidate-build-number/number
      put: alicloud-kvm-(@= stemcell.version @)
#@ end

- name: bats-(@= stemcell.version @)
  serial: true
  plan:
  - do:
    - in_parallel:
      - get: stemcell
        passed:
        - repack-stemcell-vsphere-esxi-(@= stemcell.version @)
        resource: vsphere-esxi-(@= stemcell.version @)
        tags:
        - vsphere-v6.5
        trigger: true
      - get: bosh-cli
      - get: bats
      - get: bosh-agent
        resource: bosh-agent-(@= stemcell.version @)
        passed:
        - repack-stemcell-warden-boshlite-(@= stemcell.version @)
        - repack-stemcell-aws-xen-hvm-(@= stemcell.version @)
        - repack-stemcell-azure-hyperv-(@= stemcell.version @)
        - repack-stemcell-google-kvm-(@= stemcell.version @)
        - repack-stemcell-openstack-kvm-(@= stemcell.version @)
        - repack-stemcell-openstack-kvm-raw-(@= stemcell.version @)
        - repack-stemcell-vsphere-esxi-(@= stemcell.version @)
        - repack-stemcell-vcloud-esxi-(@= stemcell.version @)
        trigger: true
      - get: bosh-deployment
      - get: bosh-stemcells-ci
      - get: bosh-linux-stemcell-builder
        passed:
        - repack-stemcell-warden-boshlite-(@= stemcell.version @)
        - repack-stemcell-aws-xen-hvm-(@= stemcell.version @)
        - repack-stemcell-azure-hyperv-(@= stemcell.version @)
        - repack-stemcell-google-kvm-(@= stemcell.version @)
        - repack-stemcell-openstack-kvm-(@= stemcell.version @)
        - repack-stemcell-openstack-kvm-raw-(@= stemcell.version @)
        - repack-stemcell-vsphere-esxi-(@= stemcell.version @)
        - repack-stemcell-vcloud-esxi-(@= stemcell.version @)
        resource: bosh-linux-stemcell-builder-(@= stemcell.version @)
      - get: version
        passed:
        - repack-stemcell-warden-boshlite-(@= stemcell.version @)
        - repack-stemcell-aws-xen-hvm-(@= stemcell.version @)
        - repack-stemcell-azure-hyperv-(@= stemcell.version @)
        - repack-stemcell-google-kvm-(@= stemcell.version @)
        - repack-stemcell-openstack-kvm-(@= stemcell.version @)
        - repack-stemcell-openstack-kvm-raw-(@= stemcell.version @)
        - repack-stemcell-vsphere-esxi-(@= stemcell.version @)
        - repack-stemcell-vcloud-esxi-(@= stemcell.version @)
        resource: version-(@= stemcell.version @)
      - get: stemcell-trigger-(@= stemcell.version @)
        passed:
        - repack-stemcell-warden-boshlite-(@= stemcell.version @)
        - repack-stemcell-aws-xen-hvm-(@= stemcell.version @)
        - repack-stemcell-azure-hyperv-(@= stemcell.version @)
        - repack-stemcell-google-kvm-(@= stemcell.version @)
        - repack-stemcell-openstack-kvm-(@= stemcell.version @)
        - repack-stemcell-openstack-kvm-raw-(@= stemcell.version @)
        - repack-stemcell-vsphere-esxi-(@= stemcell.version @)
        - repack-stemcell-vcloud-esxi-(@= stemcell.version @)
        trigger: true
    - params:
        acquire: true
      put: environment
    - do:
      - file: bosh-stemcells-ci/tasks/bats/tasks/deploy-director.yml
        params:
          BAT_INFRASTRUCTURE: vsphere
          BOSH_CLIENT: ((stemcell-test-director-username))
          BOSH_CLIENT_SECRET: ((stemcell-test-director-password))
          BOSH_VSPHERE_VCENTER: ((vcenter-ip))
          BOSH_VSPHERE_VCENTER_CLUSTER: ((vcenter-cluster))
          BOSH_VSPHERE_VCENTER_DATASTORE: ((vcenter-datastore))
          BOSH_VSPHERE_VCENTER_DC: ((vcenter-dc))
          BOSH_VSPHERE_VCENTER_DISK_PATH: ((vcenter-disk-path))
          BOSH_VSPHERE_VCENTER_PASSWORD: ((vcenter-password))
          BOSH_VSPHERE_VCENTER_RP: ((vcenter-rp))
          BOSH_VSPHERE_VCENTER_TEMPLATE_FOLDER: ((vcenter-template-folder))
          BOSH_VSPHERE_VCENTER_USER: ((vcenter-user))
          BOSH_VSPHERE_VCENTER_VLAN: ((vcenter-vlan))
          BOSH_VSPHERE_VCENTER_VM_FOLDER: ((vcenter-vm-folder))
          BOSH_VSPHERE_VERSION: ((vsphere-version))
        tags:
        - vsphere-v6.5
        task: deploy-director
      - file: bosh-stemcells-ci/tasks/bats/iaas/vsphere/prepare-bats-config.yml
        params:
          STEMCELL_NAME: bosh-vsphere-esxi-ubuntu-xenial-go_agent
        tags:
        - vsphere-v6.5
        task: prepare-bats
      - file: bats/ci/tasks/run-bats.yml
        tags:
        - vsphere-v6.5
        task: run-bats
      ensure:
        do:
        - file: bosh-stemcells-ci/tasks/bats/tasks/destroy-director.yml
          tags:
          - vsphere-v6.5
          task: teardown
    ensure:
      do:
      - params:
          release: environment
        put: environment

#@ if stemcell.version != "master":
- name: aggregate-candidate-stemcells-(@= stemcell.version @)
  serial: true
  plan:
  - in_parallel:
    - get: version
      passed:
      - test-stemcells-(@= stemcell.version @)
      - bats-(@= stemcell.version @)
      resource: version-(@= stemcell.version @)
      trigger: true
    - get: bosh-stemcells-ci
    - get: bosh-agent
      resource: bosh-agent-(@= stemcell.version @)
      passed:
      - test-stemcells-(@= stemcell.version @)
      - bats-(@= stemcell.version @)
      trigger: true
    - get: bosh-linux-stemcell-builder
      passed:
      - bats-(@= stemcell.version @)
      resource: bosh-linux-stemcell-builder-(@= stemcell.version @)
    - get: stemcells-index
    - get: stemcell-trigger-(@= stemcell.version @)
      passed:
      - test-stemcells-(@= stemcell.version @)
      - bats-(@= stemcell.version @)
      trigger: true
  - file: bosh-stemcells-ci/tasks/assert-version-aligns.yml
    task: assert-version-aligns
  - file: bosh-stemcells-ci/tasks/publish.yml
    params:
      AWS_ACCESS_KEY_ID: ((stemcell_aws_access_key))
      AWS_SECRET_ACCESS_KEY: ((stemcell_aws_secret_key))
      COMMIT_PREFIX: candidate
      COPY_KEYS: |
        aws/bosh-stemcell-%s-aws-xen-hvm-ubuntu-xenial-go_agent.tgz
        google/bosh-stemcell-%s-google-kvm-ubuntu-xenial-go_agent.tgz
        openstack/bosh-stemcell-%s-openstack-kvm-ubuntu-xenial-go_agent.tgz
        openstack/bosh-stemcell-%s-openstack-kvm-ubuntu-xenial-go_agent-raw.tgz
        warden/bosh-stemcell-%s-warden-boshlite-ubuntu-xenial-go_agent.tgz
        vsphere/bosh-stemcell-%s-vsphere-esxi-ubuntu-xenial-go_agent.tgz
        vcloud/bosh-stemcell-%s-vcloud-esxi-ubuntu-xenial-go_agent.tgz
        azure/bosh-stemcell-%s-azure-hyperv-ubuntu-xenial-go_agent.tgz
      FROM_BUCKET_NAME: bosh-core-stemcells-candidate
      FROM_INDEX: dev
      OS_NAME: ubuntu
      OS_VERSION: xenial
      TO_BUCKET_NAME: bosh-core-stemcells-candidate
      TO_INDEX: candidate
    task: copy-artifacts
  - in_parallel:
    - params:
        only_tag: true
        repository: bosh-linux-stemcell-builder
        tag: version-tag/tag
      put: bosh-linux-stemcell-builder-push-(@= stemcell.version @)
    - params:
        rebase: true
        repository: stemcells-index
      put: stemcells-index
#@ end
#@ end
- name: notify-of-usn
  plan:
  - get: xenial-usn
    trigger: true
  - config:
      image_resource:
        source:
          repository: bosh/main
        type: registry-image
      inputs:
      - name: xenial-usn
      outputs:
      - name: slack-message
      platform: linux
      run:
        args:
        - -c
        - |
          set -exu -o pipefail
          cat <<EOF > template.json
          {
            "attachments": {
              "color": "#ff0000",
                "thumb_url": "http://www.free-icons-download.net/images/lock-icon-66412.png",
                "footer": "USN Notification",
                "footer_icon": "https://i.imgur.com/7H8ZIq1.png",
                "mrkdwn_in": ["fields"],
                "fields": [
                {"title": "Priorities", "short": true, "value": (.priorities | join(", "))},
                {"title": "Date", "short": true, "value": .date},
                {"title": "Description", "short": false, "value": .description},
                {"title": "CVEs", "short": false, "value": (.cves | join("\n"))}
                ]
            }
          }
          EOF
          cat xenial-usn/usn.json | jq -r "$(cat template.json)" | tee slack-message/attachments
          cat xenial-usn/usn.json | jq -r '"New USN for Xenial: *<\(.url)|\(.title)>*"' | tee slack-message/message
        path: /bin/bash
    task: build-slack-message
  - params:
      attachments_file: slack-message/attachments
      channel: ((usn_notifications_slack_channel_name))
      icon_url: https://i.imgur.com/A0Vlw5t.png
      text_file: slack-message/message
    put: slack-alert

- name: bump-deps-bosh-agent-develop
  public: true
  plan:
  - get: weekly
    resource: weekly-bosh-agent-develop
    trigger: true
  - get: bosh-agent
    resource: bosh-agent-src-develop
  - task: bump-deps
    file: bosh-agent/ci/tasks/bump-deps.yml
  - task: test-unit
    input_mapping:
      bosh-agent: bumped-bosh-agent
    file: bosh-agent/ci/tasks/test-unit.yml
  - put: bosh-agent
    resource: bosh-agent-src-develop
    params:
      repository: bumped-bosh-agent
      rebase: true

- name: test-unit-bosh-agent-develop
  public: true
  plan:
  - get: bosh-agent
    resource: bosh-agent-src-develop
    trigger: true
  - task: test-unit
    file: bosh-agent/ci/tasks/test-unit.yml

- name: test-integration-bosh-agent-develop
  public: false
  plan:
  - get: bosh-agent
    resource: bosh-agent-src-develop
    trigger: true
  - task: test-integration
    privileged: true
    file: bosh-agent/ci/tasks/test-integration.yml
    params:
      BOSH_AWS_ACCESS_KEY_ID: ((BOSH_AWS_ACCESS_KEY_ID))
      BOSH_AWS_SECRET_ACCESS_KEY: ((BOSH_AWS_SECRET_ACCESS_KEY))
      BOSH_LITE_KEYPAIR: ((BOSH_LITE_KEYPAIR))
      BOSH_LITE_SUBNET_ID: ((BOSH_LITE_SUBNET_ID))
      BOSH_LITE_NAME: ((BOSH_LITE_NAME))
      BOSH_LITE_SECURITY_GROUP: ((BOSH_LITE_SECURITY_GROUP))
      BOSH_LITE_PRIVATE_KEY: ((BOSH_LITE_PRIVATE_KEY))
      AWS_ACCESS_KEY: ((integration_aws_access_key))
      AWS_SECRET_ACCESS_KEY: ((integration_aws_secret_access_key))
      AWS_REGION: ((integration_aws_region))
      AWS_BUCKET: ((integration_aws_bucket))


- name: bosh-integration-tests-bosh-agent-develop
  public: true
  serial: true
  build_logs_to_retain: 250
  plan:
  - in_parallel:
    - get: bosh-src
      resource: bosh-src-bosh-agent-develop
    - get: bosh-cli
      resource: bosh-cli-bosh-agent-develop
    - get: bosh-agent
      resource: bosh-agent-src-develop
      trigger: true
      passed:
      - test-unit-bosh-agent-develop
      - test-integration-bosh-agent-develop
      - windows-test-unit-bosh-agent-develop

  - task: tests
    privileged: true
    file: bosh-src/ci/tasks/test-integration.yml
    tags: ["bosh-integration"]
    params:
      DB: postgresql

- name: windows-test-unit-bosh-agent-develop
  serial: true
  plan:
  - get: bosh-agent
    resource: bosh-agent-src-develop
    trigger: true
  - task: test-unit
    file: bosh-agent/ci/tasks/test-unit-windows.yml

- name: windows-test-integration-2019-bosh-agent-develop
  serial: true
  plan:
  - get: windows-ami-2019
    resource: windows-ami-2019-bosh-agent-develop
  - get: bosh-agent
    resource: bosh-agent-src-develop
    trigger: true
    passed:
    - test-unit-bosh-agent-develop
    - test-integration-bosh-agent-develop
    - windows-test-unit-bosh-agent-develop
  - task: test-integration
    privileged: true
    file: bosh-agent/ci/tasks/test-integration-windows.yml
    input_mapping:
      windows-ami: windows-ami-2019
    params:
      AWS_ACCESS_KEY: ((WINDOWS_AWS_ACCESS_KEY))
      AWS_SECRET_KEY: ((WINDOWS_AWS_SECRET_KEY))
      AWS_SUBNET: ((WINDOWS_AWS_SUBNET))
      AWS_SSH_KEY: ((WINDOWS_AWS_SSH_KEY))
      KEYPAIR_NAME: ((WINDOWS_AWS_KEYPAIR_NAME))
      VAGRANT_PROVIDER: aws
      WINRM_PASSWORD: ((WINRM_PASSWORD))
      WINDOWS_OS_VERSION: 2019

- name: windows-test-integration-1803-bosh-agent-develop
  serial: true
  plan:
  - get: windows-ami-1803
    resource: windows-ami-1803-bosh-agent-develop
  - get: bosh-agent
    resource: bosh-agent-src-develop
    trigger: true
    passed:
    - test-unit-bosh-agent-develop
    - test-integration-bosh-agent-develop
    - windows-test-unit-bosh-agent-develop
  - task: test-integration
    privileged: true
    file: bosh-agent/ci/tasks/test-integration-windows.yml
    input_mapping:
      windows-ami: windows-ami-1803
    params:
      AWS_ACCESS_KEY: ((WINDOWS_AWS_ACCESS_KEY))
      AWS_SECRET_KEY: ((WINDOWS_AWS_SECRET_KEY))
      AWS_SUBNET: ((WINDOWS_AWS_SUBNET))
      AWS_SSH_KEY: ((WINDOWS_AWS_SSH_KEY))
      KEYPAIR_NAME: ((WINDOWS_AWS_KEYPAIR_NAME))
      VAGRANT_PROVIDER: aws
      WINRM_PASSWORD: ((WINRM_PASSWORD))
      WINDOWS_OS_VERSION: 1803

- name: windows-test-integration-2012R2-bosh-agent-develop
  serial: true
  plan:
  - get: windows-ami-2012R2
    resource: windows-ami-2012R2-bosh-agent-develop
  - get: bosh-agent
    resource: bosh-agent-src-develop
    trigger: true
    passed:
    - test-unit-bosh-agent-develop
    - test-integration-bosh-agent-develop
    - windows-test-unit-bosh-agent-develop
  - task: test-integration
    privileged: true
    file: bosh-agent/ci/tasks/test-integration-windows.yml
    input_mapping:
      windows-ami: windows-ami-2012R2
    params:
      AWS_ACCESS_KEY: ((WINDOWS_AWS_ACCESS_KEY))
      AWS_SECRET_KEY: ((WINDOWS_AWS_SECRET_KEY))
      AWS_SUBNET: ((WINDOWS_AWS_SUBNET))
      AWS_SSH_KEY: ((WINDOWS_AWS_SSH_KEY))
      KEYPAIR_NAME: ((WINDOWS_AWS_KEYPAIR_NAME))
      VAGRANT_PROVIDER: aws
      WINRM_PASSWORD: ((WINRM_PASSWORD))
      WINDOWS_OS_VERSION: 2012R2

- name: promote-bosh-agent-develop
  public: true
  serial: true
  plan:
  - in_parallel:
    - trigger: true
      passed:
      - bosh-integration-tests-bosh-agent-develop
      - windows-test-integration-2019-bosh-agent-develop
      - windows-test-integration-1803-bosh-agent-develop
      - windows-test-integration-2012R2-bosh-agent-develop
      get: bosh-agent
      resource: bosh-agent-src-develop
    - get: version-semver-bosh-agent-develop
      params: {bump: minor}
  - task: assert-version-aligns
    file: bosh-agent/ci/tasks/assert-version-aligns.yml
  - put: version-semver-bosh-agent-develop
    params:
      file: version-semver/number
  - put: bosh-agent-commit-status
    resource: bosh-agent-commit-status-bosh-agent-develop
    params:
      state: success
      commit: bosh-agent
  - put: bosh-agent-master
    resource: bosh-agent-src-master
    params:
      repository: bosh-agent
      tag: version-semver/number
      tag_prefix: v
  - in_parallel:
    - task: build-windows
      file: bosh-agent/ci/tasks/build-windows.yml
    - task: build-linux
      file: bosh-agent/ci/tasks/build-linux.yml
    - task: build-linux-ppc64le
      file: bosh-agent/ci/tasks/build-linux-ppc64le.yml
  - put: bosh-agent-index
    resource: bosh-agent-master
    params:
      files:
      - compiled-linux-*/*
      version: version-semver/number

- name: test-unit-bosh-agent-97.x
  public: true
  plan:
    - get: bosh-agent
      trigger: true
      resource: bosh-agent-src-97.x
    - task: test-unit
      file: bosh-agent/ci/tasks/test-unit.yml

- name: test-unit-bosh-agent-170.x
  public: true
  plan:
    - get: bosh-agent
      resource: bosh-agent-src-170.x
      trigger: true
    - task: test-unit
      file: bosh-agent/ci/tasks/test-unit.yml

- name: test-unit-bosh-agent-250.x
  public: true
  plan:
  - get: bosh-agent
    resource: bosh-agent-src-250.x
    trigger: true
  - task: test-unit
    file: bosh-agent/ci/tasks/test-unit.yml

- name: test-unit-bosh-agent-315.x
  public: true
  plan:
  - get: bosh-agent
    resource: bosh-agent-src-315.x
    trigger: true
  - task: test-unit
    file: bosh-agent/ci/tasks/test-unit.yml

- name: test-integration-bosh-agent-97.x
  public: false
  plan:
    - get: bosh-agent
      trigger: true
      resource: bosh-agent-src-97.x
    - task: test-integration
      privileged: true
      file: bosh-agent/ci/tasks/test-integration.yml
      params:
        BOSH_AWS_ACCESS_KEY_ID: ((BOSH_AWS_ACCESS_KEY_ID))
        BOSH_AWS_SECRET_ACCESS_KEY: ((BOSH_AWS_SECRET_ACCESS_KEY))
        BOSH_LITE_KEYPAIR: ((BOSH_LITE_KEYPAIR))
        BOSH_LITE_SUBNET_ID: ((BOSH_LITE_SUBNET_ID))
        BOSH_LITE_NAME: ((BOSH_LITE_NAME))
        BOSH_LITE_SECURITY_GROUP: ((BOSH_LITE_SECURITY_GROUP))
        BOSH_LITE_PRIVATE_KEY: ((BOSH_LITE_PRIVATE_KEY))

- name: test-integration-bosh-agent-170.x
  public: false
  plan:
    - get: bosh-agent
      resource: bosh-agent-src-170.x
      trigger: true
    - task: test-integration
      privileged: true
      file: bosh-agent/ci/tasks/test-integration.yml
      params:
        BOSH_AWS_ACCESS_KEY_ID: ((BOSH_AWS_ACCESS_KEY_ID))
        BOSH_AWS_SECRET_ACCESS_KEY: ((BOSH_AWS_SECRET_ACCESS_KEY))
        BOSH_LITE_KEYPAIR: ((BOSH_LITE_KEYPAIR))
        BOSH_LITE_SUBNET_ID: ((BOSH_LITE_SUBNET_ID))
        BOSH_LITE_NAME: ((BOSH_LITE_NAME))
        BOSH_LITE_SECURITY_GROUP: ((BOSH_LITE_SECURITY_GROUP))
        BOSH_LITE_PRIVATE_KEY: ((BOSH_LITE_PRIVATE_KEY))

- name: test-integration-bosh-agent-250.x
  public: false
  plan:
  - get: bosh-agent
    resource: bosh-agent-src-250.x
    trigger: true
  - task: test-integration
    privileged: true
    file: bosh-agent/ci/tasks/test-integration.yml
    params:
      BOSH_AWS_ACCESS_KEY_ID: ((BOSH_AWS_ACCESS_KEY_ID))
      BOSH_AWS_SECRET_ACCESS_KEY: ((BOSH_AWS_SECRET_ACCESS_KEY))
      BOSH_LITE_KEYPAIR: ((BOSH_LITE_KEYPAIR))
      BOSH_LITE_SUBNET_ID: ((BOSH_LITE_SUBNET_ID))
      BOSH_LITE_NAME: ((BOSH_LITE_NAME))
      BOSH_LITE_SECURITY_GROUP: ((BOSH_LITE_SECURITY_GROUP))
      BOSH_LITE_PRIVATE_KEY: ((BOSH_LITE_PRIVATE_KEY))

- name: test-integration-bosh-agent-315.x
  public: false
  plan:
  - get: bosh-agent
    resource: bosh-agent-src-315.x
    trigger: true
  - task: test-integration
    privileged: true
    file: bosh-agent/ci/tasks/test-integration.yml
    params:
      BOSH_AWS_ACCESS_KEY_ID: ((BOSH_AWS_ACCESS_KEY_ID))
      BOSH_AWS_SECRET_ACCESS_KEY: ((BOSH_AWS_SECRET_ACCESS_KEY))
      BOSH_LITE_KEYPAIR: ((BOSH_LITE_KEYPAIR))
      BOSH_LITE_SUBNET_ID: ((BOSH_LITE_SUBNET_ID))
      BOSH_LITE_NAME: ((BOSH_LITE_NAME))
      BOSH_LITE_SECURITY_GROUP: ((BOSH_LITE_SECURITY_GROUP))
      BOSH_LITE_PRIVATE_KEY: ((BOSH_LITE_PRIVATE_KEY))

- name: bosh-integration-tests-bosh-agent-250.x
  public: true
  serial: true
  build_logs_to_retain: 250
  plan:
  - in_parallel:
    - get: bosh-src
    - get: bosh-cli
    - get: bosh-agent
      resource: bosh-agent-src-250.x
      trigger: true
      passed:
      - test-unit-bosh-agent-250.x
      - test-integration-bosh-agent-250.x
  - task: tests
    privileged: true
    file: bosh-src/ci/tasks/test-integration.yml
    tags: ["bosh-integration"]
    params:
      DB: postgresql
      SKIP_RUN_SCRIPT_ENV: true

- name: bosh-integration-tests-bosh-agent-315.x
  public: true
  serial: true
  build_logs_to_retain: 250
  plan:
  - in_parallel:
    - get: bosh-src
    - get: bosh-cli
    - get: bosh-agent
      resource: bosh-agent-src-315.x
      trigger: true
      passed:
      - test-unit-bosh-agent-315.x
      - test-integration-bosh-agent-315.x
  - task: tests
    privileged: true
    file: bosh-src/ci/tasks/test-integration.yml
    tags: ["bosh-integration"]
    params:
      DB: postgresql

- name: promote-bosh-agent-97.x
  public: true
  serial: true
  plan:
    - in_parallel:
      - trigger: true
        passed:
        - test-unit-bosh-agent-97.x
        - test-integration-bosh-agent-97.x
        get: bosh-agent
        resource: bosh-agent-src-97.x
      - get: version-semver
        resource: version-semver-bosh-agent-97.x
        params:
          bump: patch
    - task: assert-version-aligns
      file: bosh-agent/ci/tasks/assert-version-aligns.yml
    - put: version-semver-bosh-agent-97.x
      params:
        file: version-semver/number
    - put: bosh-agent-src-97.x
      params:
        only_tag: true
        repository: bosh-agent
        tag: version-semver/number
        tag_prefix: v
    - in_parallel:
      - task: build-linux
        file: bosh-agent/ci/tasks/build-linux.yml
      - task: build-linux-ppc64le
        file: bosh-agent/ci/tasks/build-linux-ppc64le.yml
    - put: bosh-agent-97.x
      params:
        files:
        - compiled-linux-*/*
        version: version-semver/number

- name: promote-bosh-agent-170.x
  public: true
  serial: true
  plan:
    - in_parallel:
      - trigger: true
        passed:
          - test-unit-bosh-agent-170.x
          - test-integration-bosh-agent-170.x
        get: bosh-agent
        resource: bosh-agent-src-170.x
      - get: version-semver
        resource: version-semver-bosh-agent-170.x
        params: {bump: patch}
    - task: assert-version-aligns
      file: bosh-agent/ci/tasks/assert-version-aligns.yml
    - put: version-semver
      resource: version-semver-bosh-agent-170.x
      params:
        file: version-semver/number
    - put: bosh-agent-src-170.x
      params:
        repository: bosh-agent
        tag: version-semver/number
        tag_prefix: v
        only_tag: true
    - in_parallel:
      - task: build-linux
        file: bosh-agent/ci/tasks/build-linux.yml
      - task: build-linux-ppc64le
        file: bosh-agent/ci/tasks/build-linux-ppc64le.yml
    - put: bosh-agent-170.x
      params:
        files:
        - compiled-linux-*/*
        version: version-semver/number

- name: promote-bosh-agent-250.x
  public: true
  serial: true
  plan:
  - in_parallel:
    - trigger: true
      passed:
      - bosh-integration-tests-bosh-agent-250.x
      get: bosh-agent
      resource: bosh-agent-src-250.x
    - get: version-semver
      resource: version-semver-bosh-agent-250.x
      params: {bump: patch}
  - task: assert-version-aligns
    file: bosh-agent/ci/tasks/assert-version-aligns.yml
  - put: version-semver
    resource: version-semver-bosh-agent-250.x
    params:
      file: version-semver/number
  - put: bosh-agent
    resource: bosh-agent-src-250.x
    params:
      only_tag: true
      repository: bosh-agent
      tag: version-semver/number
      tag_prefix: v
  - in_parallel:
    - task: build-linux
      file: bosh-agent/ci/tasks/build-linux.yml
    - task: build-linux-ppc64le
      file: bosh-agent/ci/tasks/build-linux-ppc64le.yml
  - put: bosh-agent-250.x
    params:
      files:
      - compiled-linux-*/*
      version: version-semver/number

- name: promote-bosh-agent-315.x
  public: true
  serial: true
  plan:
  - in_parallel:
    - trigger: true
      passed:
      - bosh-integration-tests-bosh-agent-315.x
      get: bosh-agent
      resource: bosh-agent-src-315.x
    - get: version-semver
      resource: version-semver-bosh-agent-315.x
      params: {bump: patch}
  - task: assert-version-aligns
    file: bosh-agent/ci/tasks/assert-version-aligns.yml
  - put: version-semver
    resource: version-semver-bosh-agent-315.x
    params:
      file: version-semver/number
  - put: bosh-agent
    resource: version-semver-bosh-agent-315.x
    params:
      only_tag: true
      repository: bosh-agent
      tag: version-semver/number
      tag_prefix: v
  - in_parallel:
    - task: build-linux
      file: bosh-agent/ci/tasks/build-linux.yml
    - task: build-linux-ppc64le
      file: bosh-agent/ci/tasks/build-linux-ppc64le.yml
  - put: bosh-agent-315.x
    params:
      files:
      - compiled-linux-*/*
      version: version-semver/number

resource_types:
- name: ami-resource
  type: registry-image
  source:
    repository: pivotalgreenhouse/ami-resource
    tag: latest
- name: github-status
  type: registry-image
  source:
    repository: dpb587/github-status-resource
    tag: master
- name: usn
  source:
    repository: bosh/usn-resource
  type: registry-image
- name: metalink-repository
  source:
    repository: dpb587/metalink-repository-resource
  type: registry-image
- name: slack-notification
  source:
    repository: cfcommunity/slack-notification-resource
    tag: latest
  type: registry-image
resources:
#@ for stemcell in data.values.stemcells:
- name: warden-boshlite-(@= stemcell.version @)
  source:
    mirror_files:
    - destination: s3://s3.amazonaws.com/((candidate_stemcell_bucket))/warden/{{.Name}}
    options:
      private_key: ((boshio_stemcells_index_key))
    filters:
    - repositorypath: "*/warden-boshlite-go_agent.meta4"
    uri: git+ssh://git@github.com:bosh-io/stemcells-core-index.git//dev/ubuntu-xenial/
    url_handlers:
    - include:
      - (s3|https)://.*
      options:
        access_key: ((stemcell_aws_access_key))
        secret_key: ((stemcell_aws_secret_key))
      type: s3
  type: metalink-repository
#@ end
#@ for stemcell in data.values.stemcells:
- name: aws-xen-hvm-(@= stemcell.version @)
  source:
    mirror_files:
    - destination: s3://s3.amazonaws.com/((candidate_stemcell_bucket))/aws/{{.Name}}
    options:
      private_key: ((boshio_stemcells_index_key))
    filters:
    - repositorypath: "*/aws-xen-hvm-go_agent.meta4"
    uri: git+ssh://git@github.com:bosh-io/stemcells-core-index.git//dev/ubuntu-xenial/
    url_handlers:
    - include:
      - (s3|https)://.*
      options:
        access_key: ((stemcell_aws_access_key))
        secret_key: ((stemcell_aws_secret_key))
      type: s3
  type: metalink-repository
#@ end
#@ for stemcell in data.values.stemcells:
#@ if stemcell.include_alicloud:
- name: alicloud-kvm-(@= stemcell.version @)
  source:
    mirror_files:
    - destination: s3://s3.amazonaws.com/((candidate_stemcell_bucket))/alicloud/{{.Name}}
    options:
      private_key: ((boshio_stemcells_index_key))
    filters:
    - repositorypath: "*/alicloud-kvm-go_agent.meta4"
    uri: git+ssh://git@github.com:bosh-io/stemcells-core-index.git//dev/ubuntu-xenial/
    url_handlers:
    - include:
      - (s3|https)://.*
      options:
        access_key: ((stemcell_aws_access_key))
        secret_key: ((stemcell_aws_secret_key))
      type: s3
  type: metalink-repository
#@ end
#@ end
#@ for stemcell in data.values.stemcells:
- name: azure-hyperv-(@= stemcell.version @)
  source:
    mirror_files:
    - destination: s3://s3.amazonaws.com/((candidate_stemcell_bucket))/azure/{{.Name}}
    options:
      private_key: ((boshio_stemcells_index_key))
    filters:
    - repositorypath: "*/azure-hyperv-go_agent.meta4"
    uri: git+ssh://git@github.com:bosh-io/stemcells-core-index.git//dev/ubuntu-xenial/
    url_handlers:
    - include:
      - (s3|https)://.*
      options:
        access_key: ((stemcell_aws_access_key))
        secret_key: ((stemcell_aws_secret_key))
      type: s3
  type: metalink-repository
#@ end
#@ for stemcell in data.values.stemcells:
- name: openstack-kvm-(@= stemcell.version @)
  source:
    mirror_files:
    - destination: s3://s3.amazonaws.com/((candidate_stemcell_bucket))/openstack/{{.Name}}
    options:
      private_key: ((boshio_stemcells_index_key))
    filters:
    - repositorypath: "*/openstack-kvm-go_agent.meta4"
    uri: git+ssh://git@github.com:bosh-io/stemcells-core-index.git//dev/ubuntu-xenial/
    url_handlers:
    - include:
      - (s3|https)://.*
      options:
        access_key: ((stemcell_aws_access_key))
        secret_key: ((stemcell_aws_secret_key))
      type: s3
  type: metalink-repository
#@ end
#@ for stemcell in data.values.stemcells:
- name: google-kvm-(@= stemcell.version @)
  source:
    mirror_files:
    - destination: s3://s3.amazonaws.com/((candidate_stemcell_bucket))/google/{{.Name}}
    options:
      private_key: ((boshio_stemcells_index_key))
    filters:
    - repositorypath: "*/google-kvm-go_agent.meta4"
    uri: git+ssh://git@github.com:bosh-io/stemcells-core-index.git//dev/ubuntu-xenial/
    url_handlers:
    - include:
      - (s3|https)://.*
      options:
        access_key: ((stemcell_aws_access_key))
        secret_key: ((stemcell_aws_secret_key))
      type: s3
  type: metalink-repository
#@ end
#@ for stemcell in data.values.stemcells:
- name: vsphere-esxi-(@= stemcell.version @)
  source:
    mirror_files:
    - destination: s3://s3.amazonaws.com/((candidate_stemcell_bucket))/vsphere/{{.Name}}
    options:
      private_key: ((boshio_stemcells_index_key))
    filters:
    - repositorypath: "*/vsphere-esxi-go_agent.meta4"
    uri: git+ssh://git@github.com:bosh-io/stemcells-core-index.git//dev/ubuntu-xenial/
    url_handlers:
    - include:
      - (s3|https)://.*
      options:
        access_key: ((stemcell_aws_access_key))
        secret_key: ((stemcell_aws_secret_key))
      type: s3
  type: metalink-repository
#@ end
#@ for stemcell in data.values.stemcells:
- name: vcloud-esxi-(@= stemcell.version @)
  source:
    mirror_files:
    - destination: s3://s3.amazonaws.com/((candidate_stemcell_bucket))/vcloud/{{.Name}}
    options:
      private_key: ((boshio_stemcells_index_key))
    filters:
    - repositorypath: "*/vcloud-esxi-go_agent.meta4"
    uri: git+ssh://git@github.com:bosh-io/stemcells-core-index.git//dev/ubuntu-xenial/
    url_handlers:
    - include:
      - (s3|https)://.*
      options:
        access_key: ((stemcell_aws_access_key))
        secret_key: ((stemcell_aws_secret_key))
      type: s3
  type: metalink-repository
#@ end
#@ for stemcell in data.values.stemcells:
- name: os-image-tarball-(@= stemcell.version @)
  source:
    mirror_files:
    - destination: s3://s3.amazonaws.com/((osimage_bucket))/(@= stemcell.version @)/{{.Name}}
    options:
      private_key: ((bosh_src_key))
    filters:
    - repositorypath: "ubuntu-xenial.meta4"
    uri: git+ssh://git@github.com:cloudfoundry/bosh-linux-stemcell-builder.git//bosh-stemcell/image-metalinks/#(@= stemcell.branch @)
    url_handlers:
    - include:
      - (s3|https)://.*
      options:
        access_key: ((osimage_aws_access_key))
        secret_key: ((osimage_aws_secret_key))
      type: s3
  type: metalink-repository
#@ end
#@ for stemcell in data.values.stemcells:
- name: version-(@= stemcell.version @)
  source:
    access_key_id: ((stemcell_aws_access_key))
    bucket: ((candidate_stemcell_bucket))
    driver: s3
    initial_version: (@= stemcell.initial_version @)
    key: bosh-stemcell/ubuntu-xenial/(@= stemcell.version @)-version
    secret_access_key: ((stemcell_aws_secret_key))
  type: semver
- name: os-image-version-(@= stemcell.version @)
  source:
    access_key_id: ((stemcell_aws_access_key))
    bucket: ((candidate_stemcell_bucket))
    driver: s3
    initial_version: "0.0.0"
    key: os-image/ubuntu-xenial/(@= stemcell.version @)-version
    secret_access_key: ((stemcell_aws_secret_key))
  type: semver
#@ end
- name: bosh-stemcells-ci
  source:
    branch: master
    uri: https://github.com/cloudfoundry/bosh-stemcells-ci
  type: git
- name: bats
  source:
    branch: master
    uri: https://github.com/cloudfoundry/bosh-acceptance-tests.git
  type: git
- name: stemcells-index
  source:
    branch: master
    private_key: ((boshio_stemcells_index_key))
    uri: git@github.com:bosh-io/stemcells-core-index.git
  type: git
- name: syslog-release
  source:
    repository: cloudfoundry/syslog-release
  type: bosh-io-release
- name: os-conf-release
  source:
    repository: cloudfoundry/os-conf-release
  type: bosh-io-release
- name: bosh-deployment
  source:
    branch: master
    uri: https://github.com/cloudfoundry/bosh-deployment
  type: git
- name: xenial-usn-low-medium
  source:
    os: ubuntu-16.04-lts
    priorities:
    - low
    - medium
  type: usn
- name: bosh-cli
  source:
    bucket: bosh-cli-artifacts
    regexp: bosh-cli-([0-9.]+)-linux-amd64
    region_name: us-east-1
  type: s3
- name: environment
  source:
    branch: master
    pool: vsphere
    private_key: ((github_deployment_key__bosh-cpi-environments))
    uri: git@github.com:pivotal-cf-experimental/bats-concourse-pool.git
  type: pool
- name: every-2-weeks-on-monday
  source:
    days:
    - Monday
    interval: 192h
    location: America/Los_Angeles
    start: "6:00"
    stop: "8:30"
  type: time
- name: xenial-usn
  source:
    os: ubuntu-16.04-lts
    priorities:
    - high
    - critical
  type: usn
- name: bosh-linux-stemcell-builder-master
  source:
    branch: master
    ignore_paths:
    - VERSION
    - bosh-stemcell/image-metalinks/ubuntu-trusty.meta4
    - bosh-stemcell/image-metalinks/ubuntu-xenial.meta4
    - bosh-stemcell/image-metalinks/centos-7.meta4.meta4
    uri: https://github.com/cloudfoundry/bosh-linux-stemcell-builder
  type: git
- name: stemcell-trigger-master
  source:
    access_key_id: ((bosh_usn_and_periodic_aws_access_key_id))
    bucket: bosh-stemcell-triggers
    secret_access_key: ((bosh_usn_and_periodic_aws_secret_access_key))
    versioned_file: master/stemcell-trigger
  type: s3
- name: usn-log-master
  source:
    access_key_id: ((bosh_usn_and_periodic_aws_access_key_id))
    bucket: bosh-stemcell-triggers
    initial_context_text: ""
    initial_version: '-'
    secret_access_key: ((bosh_usn_and_periodic_aws_secret_access_key))
    versioned_file: master/usn-log.json
  type: s3
- name: slack-alert
  source:
    url: ((slack_hook_url))
  type: slack-notification
- name: bosh-linux-stemcell-builder-push-97.x
  source:
    branch: ubuntu-xenial/97.x
    private_key: ((bosh_src_key))
    uri: git@github.com:cloudfoundry/bosh-linux-stemcell-builder
  type: git
- name: bosh-linux-stemcell-builder-97.x
  source:
    branch: ubuntu-xenial/97.x
    ignore_paths:
    - VERSION
    - bosh-stemcell/image-metalinks/ubuntu-trusty.meta4
    - bosh-stemcell/image-metalinks/centos-7.meta4.meta4
    uri: https://github.com/cloudfoundry/bosh-linux-stemcell-builder
  type: git
- name: stemcell-trigger-97.x
  source:
    access_key_id: ((bosh_usn_and_periodic_aws_access_key_id))
    bucket: bosh-stemcell-triggers
    secret_access_key: ((bosh_usn_and_periodic_aws_secret_access_key))
    versioned_file: 97.x/stemcell-trigger
  type: s3
- name: usn-log-97.x
  source:
    access_key_id: ((bosh_usn_and_periodic_aws_access_key_id))
    bucket: bosh-stemcell-triggers
    initial_context_text: ""
    initial_version: '-'
    secret_access_key: ((bosh_usn_and_periodic_aws_secret_access_key))
    versioned_file: 97.x/usn-log.json
  type: s3
- name: bosh-linux-stemcell-builder-push-170.x
  source:
    branch: ubuntu-xenial/170.x
    private_key: ((bosh_src_key))
    uri: git@github.com:cloudfoundry/bosh-linux-stemcell-builder
  type: git
- name: bosh-linux-stemcell-builder-170.x
  source:
    branch: ubuntu-xenial/170.x
    ignore_paths:
    - VERSION
    - bosh-stemcell/image-metalinks/ubuntu-trusty.meta4
    - bosh-stemcell/image-metalinks/centos-7.meta4.meta4
    uri: https://github.com/cloudfoundry/bosh-linux-stemcell-builder
  type: git
- name: bosh-agent-170.x
  source:
    uri: git+https://github.com/cloudfoundry/bosh-agent-index.git
    version: 2.160.*
  type: metalink-repository
- name: stemcell-trigger-170.x
  source:
    access_key_id: ((bosh_usn_and_periodic_aws_access_key_id))
    bucket: bosh-stemcell-triggers
    secret_access_key: ((bosh_usn_and_periodic_aws_secret_access_key))
    versioned_file: 170.x/stemcell-trigger
  type: s3
- name: usn-log-170.x
  source:
    access_key_id: ((bosh_usn_and_periodic_aws_access_key_id))
    bucket: bosh-stemcell-triggers
    initial_context_text: ""
    initial_version: '-'
    secret_access_key: ((bosh_usn_and_periodic_aws_secret_access_key))
    versioned_file: 170.x/usn-log.json
  type: s3
- name: bosh-linux-stemcell-builder-push-250.x
  source:
    branch: ubuntu-xenial/250.x
    private_key: ((bosh_src_key))
    uri: git@github.com:cloudfoundry/bosh-linux-stemcell-builder
  type: git
- name: bosh-linux-stemcell-builder-250.x
  source:
    branch: ubuntu-xenial/250.x
    ignore_paths:
    - VERSION
    - bosh-stemcell/image-metalinks/ubuntu-trusty.meta4
    - bosh-stemcell/image-metalinks/centos-7.meta4.meta4
    uri: https://github.com/cloudfoundry/bosh-linux-stemcell-builder
  type: git
- name: stemcell-trigger-250.x
  source:
    access_key_id: ((bosh_usn_and_periodic_aws_access_key_id))
    bucket: bosh-stemcell-triggers
    secret_access_key: ((bosh_usn_and_periodic_aws_secret_access_key))
    versioned_file: 250.x/stemcell-trigger
  type: s3
- name: usn-log-250.x
  source:
    access_key_id: ((bosh_usn_and_periodic_aws_access_key_id))
    bucket: bosh-stemcell-triggers
    initial_context_text: ""
    initial_version: '-'
    secret_access_key: ((bosh_usn_and_periodic_aws_secret_access_key))
    versioned_file: 250.x/usn-log.json
  type: s3
- name: bosh-linux-stemcell-builder-push-315.x
  source:
    branch: ubuntu-xenial/315.x
    private_key: ((bosh_src_key))
    uri: git@github.com:cloudfoundry/bosh-linux-stemcell-builder
  type: git
- name: bosh-linux-stemcell-builder-315.x
  source:
    branch: ubuntu-xenial/315.x
    ignore_paths:
    - VERSION
    - bosh-stemcell/image-metalinks/ubuntu-trusty.meta4
    - bosh-stemcell/image-metalinks/centos-7.meta4.meta4
    uri: https://github.com/cloudfoundry/bosh-linux-stemcell-builder
  type: git
- name: stemcell-trigger-315.x
  source:
    access_key_id: ((bosh_usn_and_periodic_aws_access_key_id))
    bucket: bosh-stemcell-triggers
    secret_access_key: ((bosh_usn_and_periodic_aws_secret_access_key))
    versioned_file: 315.x/stemcell-trigger
  type: s3
- name: usn-log-315.x
  source:
    access_key_id: ((bosh_usn_and_periodic_aws_access_key_id))
    bucket: bosh-stemcell-triggers
    initial_context_text: ""
    initial_version: '-'
    secret_access_key: ((bosh_usn_and_periodic_aws_secret_access_key))
    versioned_file: 315.x/usn-log.json
  type: s3
- name: bosh-linux-stemcell-builder-push-456.x
  source:
    branch: ubuntu-xenial/456.x
    private_key: ((bosh_src_key))
    uri: git@github.com:cloudfoundry/bosh-linux-stemcell-builder
  type: git
- name: bosh-linux-stemcell-builder-456.x
  source:
    branch: ubuntu-xenial/456.x
    ignore_paths:
    - VERSION
    - bosh-stemcell/image-metalinks/ubuntu-trusty.meta4
    - bosh-stemcell/image-metalinks/centos-7.meta4.meta4
    uri: https://github.com/cloudfoundry/bosh-linux-stemcell-builder
  type: git
- name: bosh-agent-456.x
  source:
    uri: git+https://github.com/cloudfoundry/bosh-agent-index.git
    version: 2.234.*
  type: metalink-repository
- name: stemcell-trigger-456.x
  source:
    access_key_id: ((bosh_usn_and_periodic_aws_access_key_id))
    bucket: bosh-stemcell-triggers
    secret_access_key: ((bosh_usn_and_periodic_aws_secret_access_key))
    versioned_file: 456.x/stemcell-trigger
  type: s3
- name: usn-log-456.x
  source:
    access_key_id: ((bosh_usn_and_periodic_aws_access_key_id))
    bucket: bosh-stemcell-triggers
    initial_context_text: ""
    initial_version: '-'
    secret_access_key: ((bosh_usn_and_periodic_aws_secret_access_key))
    versioned_file: 456.x/usn-log.json
  type: s3

- name: bosh-agent-src-develop
  type: git
  source:
    uri: git@github.com:cloudfoundry/bosh-agent.git
    branch: develop
    private_key: ((BOSH_GITHUB_DEPLOYMENT_KEY))

- name: bosh-agent-src-master
  type: git
  source:
    uri: git@github.com:cloudfoundry/bosh-agent.git
    branch: master
    private_key: ((BOSH_GITHUB_DEPLOYMENT_KEY))

- name: bosh-agent-master
  type: metalink-repository
  source:
    uri: git+ssh://git@github.com:cloudfoundry/bosh-agent-index.git//
    version: '*'
    mirror_files:
    - destination: s3://s3-external-1.amazonaws.com/((RELEASE_BUCKET_AGENT))/{{.Name}}
    options:
      private_key: ((BOSH_AGENT_INDEX_DEPLOYMENT_PRIVATE_KEY))
    url_handlers:
    - type: s3
      options:
        access_key: ((AWS_S3_BUCKET_ACCESS_KEY))
        secret_key: ((AWS_S3_BUCKET_SECRET_KEY))

- name: bosh-agent-97.x
  type: metalink-repository
  source:
    uri: git+ssh://git@github.com:cloudfoundry/bosh-agent-index.git//
    version: 2.117.*
    mirror_files:
    - destination: s3://s3-external-1.amazonaws.com/((RELEASE_BUCKET_AGENT))/{{.Name}}
    options:
      private_key: ((BOSH_AGENT_INDEX_DEPLOYMENT_PRIVATE_KEY))
    url_handlers:
    - type: s3
      options:
        access_key: ((AWS_S3_BUCKET_ACCESS_KEY))
        secret_key: ((AWS_S3_BUCKET_SECRET_KEY))

- name: bosh-agent-250.x
  type: metalink-repository
  source:
    uri: git+ssh://git@github.com:cloudfoundry/bosh-agent-index.git//
    version: 2.193.*
    mirror_files:
    - destination: s3://s3-external-1.amazonaws.com/((RELEASE_BUCKET_AGENT))/{{.Name}}
    options:
      private_key: ((BOSH_AGENT_INDEX_DEPLOYMENT_PRIVATE_KEY))
    url_handlers:
    - type: s3
      options:
        access_key: ((AWS_S3_BUCKET_ACCESS_KEY))
        secret_key: ((AWS_S3_BUCKET_SECRET_KEY))

- name: bosh-agent-315.x
  type: metalink-repository
  source:
    uri: git+ssh://git@github.com:cloudfoundry/bosh-agent-index.git//
    version: 2.215.*
    mirror_files:
    - destination: s3://s3-external-1.amazonaws.com/((RELEASE_BUCKET_AGENT))/{{.Name}}
    options:
      private_key: ((BOSH_AGENT_INDEX_DEPLOYMENT_PRIVATE_KEY))
    url_handlers:
    - type: s3
      options:
        access_key: ((AWS_S3_BUCKET_ACCESS_KEY))
        secret_key: ((AWS_S3_BUCKET_SECRET_KEY))

- name: bosh-agent-src-250.x
  type: git
  source:
    uri: git@github.com:cloudfoundry/bosh-agent.git
    branch: 2.193.x
    private_key: ((BOSH_GITHUB_DEPLOYMENT_KEY))

- name: bosh-src
  type: git
  source:
    uri: https://github.com/cloudfoundry/bosh.git
    branch: master

- name: version-semver-bosh-agent-250.x
  type: semver
  source:
    initial_version: 2.193.0
    key: agent-2.193-current-version
    bucket: ((SEMVER_BUCKET))
    region_name: ((AWS_S3_BUCKET_REGION))
    access_key_id: ((AWS_S3_BUCKET_ACCESS_KEY))
    secret_access_key: ((AWS_S3_BUCKET_SECRET_KEY))

- name: bosh-agent-commit-status-bosh-agent-develop
  type: github-status
  source:
    repository: cloudfoundry/bosh-agent
    access_token: ((repo_github_token))
    branch: develop
    context: ci/published

- name: bosh-src-bosh-agent-develop
  type: git
  source:
    uri: https://github.com/cloudfoundry/bosh.git
    branch: master

- name: bosh-cli-bosh-agent-develop
  type: s3
  source:
    regexp: alpha-bosh-cli-(.*)-linux-amd64
    bucket: bosh-cli-alpha-artifacts
    region_name: us-east-1

- name: windows-ami-2012R2-bosh-agent-develop
  type: ami-resource
  source:
    access_key_id: ((WINDOWS_AWS_ACCESS_KEY))
    secret_access_key: ((WINDOWS_AWS_SECRET_KEY))
    region: us-east-1
    search_options:
      filters:
      - name: name
        values:
        - Windows_Server-2012-R2_RTM-English-64Bit-Base*
      - name: state
        values:
        - available
      owners:
      - amazon

- name: windows-ami-1803-bosh-agent-develop
  type: ami-resource
  source:
    access_key_id: ((WINDOWS_AWS_ACCESS_KEY))
    secret_access_key: ((WINDOWS_AWS_SECRET_KEY))
    region: us-east-1
    search_options:
      filters:
      - name: name
        values:
        - Windows_Server-1803-English-Core-Base*
      - name: state
        values:
        - available
      owners:
      - amazon

- name: windows-ami-2019-bosh-agent-develop
  type: ami-resource
  source:
    access_key_id: ((WINDOWS_AWS_ACCESS_KEY))
    secret_access_key: ((WINDOWS_AWS_SECRET_KEY))
    region: us-east-1
    search_options:
      filters:
      - name: name
        values:
        - Windows_Server-2019-English-Core-Base*
      - name: state
        values:
        - available
      owners:
      - amazon

- name: version-semver-bosh-agent-develop
  type: semver
  source:
    initial_version: 0.0.1
    key: agent-current-version
    bucket: ((SEMVER_BUCKET))
    region_name: ((AWS_S3_BUCKET_REGION))
    access_key_id: ((AWS_S3_BUCKET_ACCESS_KEY))
    secret_access_key: ((AWS_S3_BUCKET_SECRET_KEY))

- name: bosh-agent-src-97.x
  type: git
  source:
    uri: git@github.com:cloudfoundry/bosh-agent.git
    branch: 2.117.x
    private_key: ((BOSH_GITHUB_DEPLOYMENT_KEY))

- name: bosh-agent-src-315.x
  type: git
  source:
    uri: git@github.com:cloudfoundry/bosh-agent.git
    branch: 2.215.x
    private_key: ((BOSH_GITHUB_DEPLOYMENT_KEY))

- name: version-semver-bosh-agent-97.x
  type: semver
  source:
    initial_version: 2.117.0
    key: agent-2.117-current-version
    bucket: ((SEMVER_BUCKET))
    region_name: ((AWS_S3_BUCKET_REGION))
    access_key_id: ((AWS_S3_BUCKET_ACCESS_KEY))
    secret_access_key: ((AWS_S3_BUCKET_SECRET_KEY))

- name: version-semver-bosh-agent-315.x
  type: semver
  source:
    initial_version: 2.215.0
    key: agent-2.215-current-version
    bucket: ((SEMVER_BUCKET))
    region_name: ((AWS_S3_BUCKET_REGION))
    access_key_id: ((AWS_S3_BUCKET_ACCESS_KEY))
    secret_access_key: ((AWS_S3_BUCKET_SECRET_KEY))

- name: bosh-agent-src-170.x
  type: git
  source:
    uri: git@github.com:cloudfoundry/bosh-agent.git
    branch: 2.160.x
    private_key: ((BOSH_GITHUB_DEPLOYMENT_KEY))

- name: version-semver-bosh-agent-170.x
  type: semver
  source:
    initial_version: 2.160.0
    key: agent-2.160-current-version
    bucket: ((SEMVER_BUCKET))
    region_name: ((AWS_S3_BUCKET_REGION))
    access_key_id: ((AWS_S3_BUCKET_ACCESS_KEY))
    secret_access_key: ((AWS_S3_BUCKET_SECRET_KEY))

- name: weekly-bosh-agent-develop
  type: time
  source:
    start: 3:00 -0700
    stop: 4:30 -0700
    days: [Saturday]
