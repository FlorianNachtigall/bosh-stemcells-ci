---
groups:
- name: all
  jobs:
  - manual-trigger
  - create-story
  - create-story-usn
  - notify-of-usn
  - build-ubuntu-trusty-image
  - bump-os-image
  - test-unit
  - build-stemcell
  - test-stemcells
  - build-warden-boshlite-ubuntu-trusty
  - build-aws-xen-hvm-ubuntu-trusty
  - build-azure-hyperv-ubuntu-trusty
  - build-google-kvm-ubuntu-trusty
  - build-openstack-kvm-ubuntu-trusty
  - build-vsphere-esxi-ubuntu-trusty
  - build-vcloud-esxi-ubuntu-trusty
  - bats-ubuntu
  - delivery
  - aggregate-candidate-stemcells
- name: triggers
  jobs:
  - create-story
  - create-story-usn
  - manual-trigger
- jobs:
  - build-ubuntu-trusty-image
  - bump-os-image
  name: os-images
- name: stemcells
  jobs:
  - test-unit
  - build-stemcell
  - test-stemcells
  - build-warden-boshlite-ubuntu-trusty
  - build-aws-xen-hvm-ubuntu-trusty
  - build-azure-hyperv-ubuntu-trusty
  - build-google-kvm-ubuntu-trusty
  - build-openstack-kvm-ubuntu-trusty
  - build-vsphere-esxi-ubuntu-trusty
  - build-vcloud-esxi-ubuntu-trusty
  - bats-ubuntu
  - aggregate-candidate-stemcells
- name: aws
  jobs:
  - build-aws-xen-hvm-ubuntu-trusty
- name: azure
  jobs:
  - build-azure-hyperv-ubuntu-trusty
- name: google
  jobs:
  - build-google-kvm-ubuntu-trusty
- name: openstack
  jobs:
  - build-openstack-kvm-ubuntu-trusty
- name: vsphere
  jobs:
  - build-vsphere-esxi-ubuntu-trusty
- name: vcloud
  jobs:
  - build-vcloud-esxi-ubuntu-trusty
- name: ubuntu
  jobs:
  - build-aws-xen-hvm-ubuntu-trusty
  - build-azure-hyperv-ubuntu-trusty
  - build-google-kvm-ubuntu-trusty
  - build-openstack-kvm-ubuntu-trusty
  - build-vsphere-esxi-ubuntu-trusty
  - build-vcloud-esxi-ubuntu-trusty
- name: bats
  jobs:
  - bats-ubuntu
- name: os-images
  jobs:
  - build-ubuntu-trusty-image
  - bump-os-image

shared:
- &deploy-director
  task: deploy-director
  tags: [vsphere-v6.5]
  file: bosh-stemcells-ci/pipelines/ubuntu-trusty/3586.x/bats/tasks/deploy-director.yml
  params:
    BAT_INFRASTRUCTURE: vsphere
    BOSH_CLIENT:                          ((stemcell-test-director-username))
    BOSH_CLIENT_SECRET:                   ((stemcell-test-director-password))
    BOSH_VSPHERE_VCENTER:                 ((vcenter-ip))
    BOSH_VSPHERE_VCENTER_USER:            ((vcenter-user))
    BOSH_VSPHERE_VCENTER_PASSWORD:        ((vcenter-password))
    BOSH_VSPHERE_VERSION:                 ((vsphere-version))
    BOSH_VSPHERE_VCENTER_DC:              ((vcenter-dc))
    BOSH_VSPHERE_VCENTER_CLUSTER:         ((vcenter-cluster))
    BOSH_VSPHERE_VCENTER_DATASTORE:       ((vcenter-datastore))
    BOSH_VSPHERE_VCENTER_VLAN:            ((vcenter-vlan))
    BOSH_VSPHERE_VCENTER_VM_FOLDER:       ((vcenter-vm-folder))
    BOSH_VSPHERE_VCENTER_TEMPLATE_FOLDER: ((vcenter-template-folder))
    BOSH_VSPHERE_VCENTER_DISK_PATH:       ((vcenter-disk-path))
    BOSH_VSPHERE_VCENTER_RP:              ((vcenter-rp))

- &prepare-bats-config
  task: prepare-bats
  tags: [vsphere-v6.5]
  file: bosh-stemcells-ci/pipelines/ubuntu-trusty/3586.x/bats/iaas/vsphere/prepare-bats-config.yml

- &run-bats
  task: run-bats
  tags: [vsphere-v6.5]
  file: bats/ci/tasks/run-bats.yml

- &teardown
  task: teardown
  tags: [vsphere-v6.5]
  file: bosh-stemcells-ci/pipelines/ubuntu-trusty/3586.x/bats/tasks/destroy-director.yml

- &stemcell_bucket
  bucket: ((candidate_stemcell_bucket))
  access_key_id: ((stemcell_aws_access_key))
  secret_access_key: ((stemcell_aws_secret_key))

jobs:
- name: manual-trigger
  plan:
  - get: bosh-stemcells-ci
  - task: write-message
    file: bosh-stemcells-ci/tasks/write-bump-message.yml
    params:
      MESSAGE_PREFIX: "Manual bump"
  - put: stemcell-trigger
    params:
      file: message/message.txt

- name: create-story
  plan:
  - aggregate:
    - get: every-2-weeks-on-monday
      trigger: true
    - get: bosh-stemcells-ci
    - get: bosh-linux-stemcell-builder
  - task: create-story
    file: bosh-stemcells-ci/pipelines/ubuntu-trusty/3586.x/tasks/create-story.yml
    params:
      BRANCH: master
      PROJECT_ID: ((story_creator_tracker_project_id))
      TOKEN: ((story_creator_tracker_token))
      DESCRIPTION: "stemcell periodic bump"
  - task: write-message
    file: bosh-stemcells-ci/tasks/write-bump-message.yml
    params:
      MESSAGE_PREFIX: "Periodic bump"
  - put: stemcell-trigger
    params:
      file: message/message.txt

- name: notify-of-usn
  plan:
  - get: trusty-usn
    trigger: true
  - task: build-slack-message
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: bosh/main
      inputs: [{ name: trusty-usn }]
      outputs: [{ name: slack-message }]
      run:
        path: /bin/bash
        args:
        - -c
        - |
          set -exu -o pipefail
          cat <<EOF > template.json
          {
            "attachments": {
              "color": "#ff0000",
                "thumb_url": "http://www.free-icons-download.net/images/lock-icon-66412.png",
                "footer": "USN Notification",
                "footer_icon": "https://i.imgur.com/7H8ZIq1.png",
                "mrkdwn_in": ["fields"],
                "fields": [
                {"title": "Priorities", "short": true, "value": (.priorities | join(", "))},
                {"title": "Date", "short": true, "value": .date},
                {"title": "Description", "short": false, "value": .description},
                {"title": "CVEs", "short": false, "value": (.cves | join("\n"))}
                ]
            }
          }
          EOF
          cat trusty-usn/usn.json | jq -r "$(cat template.json)" | tee slack-message/attachments
          cat trusty-usn/usn.json | jq -r '"New USN for Trusty: *<\(.url)|\(.title)>*"' | tee slack-message/message
  - put: slack-alert
    params:
      channel: ((usn_notifications_slack_channel_name))
      icon_url: https://i.imgur.com/A0Vlw5t.png
      attachments_file: slack-message/attachments
      text_file: slack-message/message

- name: create-story-usn
  plan:
  - aggregate:
    - get: usn
      resource: trusty-usn
      trigger: true
    - get: bosh-stemcells-ci
    - get: bosh-linux-stemcell-builder
  - task: create-story
    file: bosh-stemcells-ci/pipelines/ubuntu-trusty/3586.x/tasks/create-story.yml
    params:
      BRANCH: master
      PROJECT_ID: ((story_creator_private_tracker_project_id))
      TOKEN: ((story_creator_tracker_token))
      DESCRIPTION: "ubuntu *security* notice"
  - task: write-message
    file: bosh-stemcells-ci/tasks/write-bump-message.yml
    params:
      MESSAGE_PREFIX: "Addresses"
  - put: stemcell-trigger
    params:
      file: message/message.txt

- name: build-ubuntu-trusty-image
  plan:
  - get: bosh-stemcells-ci
  - get: bosh-linux-stemcell-builder
  - get: stemcell-trigger
    trigger: true
  - task: build
    file: bosh-stemcells-ci/pipelines/ubuntu-trusty/3586.x/os-images/tasks/build.yml
    privileged: true
    params:
      OPERATING_SYSTEM_NAME:      ubuntu
      OPERATING_SYSTEM_VERSION:   trusty
  - put: ubuntu-trusty-tarball
    params:
      file: os-image/ubuntu-trusty.tgz
      acl: public-read

- name: bump-os-image
  plan:
  - aggregate:
    - get: bosh-stemcells-ci
    - get: bosh-linux-stemcell-builder
      passed:
      - build-ubuntu-trusty-image
    - get: ubuntu-trusty-tarball
      trigger: true
      passed:
        - build-ubuntu-trusty-image
    - get: stemcell-trigger
      trigger: true
      passed:
      - build-ubuntu-trusty-image
  - task: bump-os-image
    file: bosh-stemcells-ci/pipelines/ubuntu-trusty/3586.x/os-images/tasks/bump-os-image.yml
  - put: bosh-linux-stemcell-builder-push
    params:
      repository: bosh-linux-stemcell-builder-push
      rebase: true

- name: test-unit
  serial: true
  plan:
  - get: bosh-stemcells-ci
  - get: stemcell-trigger
    passed:
    - bump-os-image
    trigger: true
  - get: bosh-linux-stemcell-builder
    trigger: true
  - task: test-unit
    file: bosh-stemcells-ci/pipelines/ubuntu-trusty/3586.x/tasks/test-unit.yml

- name: build-stemcell
  serial: true
  plan:
  - get: bosh-stemcells-ci
  - get: bosh-linux-stemcell-builder
    trigger: true
    passed:
    - test-unit
  - get: stemcell-trigger
    passed:
    - test-unit
    trigger: true
  - get: version
    params:
      bump: ((stemcell_version_semver_bump))
  - put: version
    params:
      file: version/number

- name: test-stemcells
  serial: true
  plan:
  - aggregate:
    - get: version
      trigger: true
      passed:
      - build-warden-boshlite-ubuntu-trusty
      - build-aws-xen-hvm-ubuntu-trusty
      - build-azure-hyperv-ubuntu-trusty
      - build-google-kvm-ubuntu-trusty
      - build-openstack-kvm-ubuntu-trusty
      - build-vsphere-esxi-ubuntu-trusty
      - build-vcloud-esxi-ubuntu-trusty
    - get: bosh-stemcells-ci
    - get: bosh-linux-stemcell-builder
    - get: bosh-deployment
    - get: bosh-cli
    - get: syslog-release
    - get: os-conf-release
    - get: stemcell-trigger
      passed:
      - build-warden-boshlite-ubuntu-trusty
      - build-aws-xen-hvm-ubuntu-trusty
      - build-azure-hyperv-ubuntu-trusty
      - build-google-kvm-ubuntu-trusty
      - build-openstack-kvm-ubuntu-trusty
      - build-vsphere-esxi-ubuntu-trusty
      - build-vcloud-esxi-ubuntu-trusty
      trigger: true
    - get: vsphere-esxi-ubuntu-trusty
      passed: [build-vsphere-esxi-ubuntu-trusty]
      tags:
      - vsphere-v6.5
  - do:
    - put: environment
      params:
        acquire: true
    - do:
      - task: deploy-director
        tags: [vsphere-v6.5]
        file: bosh-stemcells-ci/pipelines/ubuntu-trusty/3586.x/tasks/deploy-director.yml
        params:
          BOSH_vcenter_ip:          ((vcenter-ip))
          BOSH_vcenter_user:        ((vcenter-user))
          BOSH_vcenter_password:    ((vcenter-password))
          BOSH_vcenter_dc:          ((vcenter-dc))
          BOSH_vcenter_cluster:     ((vcenter-cluster))
          BOSH_vcenter_ds:          ((vcenter-datastore))
          BOSH_vcenter_vms:         ((vcenter-vm-folder))
          BOSH_vcenter_templates:   ((vcenter-template-folder))
          BOSH_vcenter_disks:       ((vcenter-disk-path))
          BOSH_vcenter_rp:          ((vcenter-rp))
      - task: test-stemcell
        attempts: 3
        tags: [vsphere-v6.5]
        file: bosh-stemcells-ci/pipelines/ubuntu-trusty/3586.x/tasks/test-stemcell.yml
        input_mapping:
          stemcell: vsphere-esxi-ubuntu-trusty
        params:
          BOSH_os_name: ubuntu-trusty
          package: ipv4director
      ensure:
        task: teardown-director
        tags: [vsphere-v6.5]
        file: bosh-stemcells-ci/pipelines/ubuntu-trusty/3586.x/tasks/teardown.yml
    - do:
      - task: deploy-director-ipv6
        tags: [vsphere-v6.5]
        file: bosh-stemcells-ci/pipelines/ubuntu-trusty/3586.x/tasks/deploy-director-ipv6.yml
        params:
          BOSH_vcenter_ip:          ((vcenter-ip))
          BOSH_vcenter_user:        ((vcenter-user))
          BOSH_vcenter_password:    ((vcenter-password))
          BOSH_vcenter_dc:          ((vcenter-dc))
          BOSH_vcenter_cluster:     ((vcenter-cluster))
          BOSH_vcenter_ds:          ((vcenter-datastore))
          BOSH_vcenter_vms:         ((vcenter-vm-folder))
          BOSH_vcenter_templates:   ((vcenter-template-folder))
          BOSH_vcenter_disks:       ((vcenter-disk-path))
          BOSH_vcenter_rp:          ((vcenter-rp))
      - task: test-stemcell-ipv6
        attempts: 3
        tags: [vsphere-v6.5]
        file: bosh-stemcells-ci/pipelines/ubuntu-trusty/3586.x/tasks/test-stemcell.yml
        input_mapping:
          stemcell: vsphere-esxi-ubuntu-trusty
        params:
          package: ipv6director
      ensure:
        task: teardown-director-ipv6
        tags: [vsphere-v6.5]
        file: bosh-stemcells-ci/pipelines/ubuntu-trusty/3586.x/tasks/teardown.yml
    ensure:
      put: environment
      params:
        release: environment

#
# WARDEN
#

- name: build-warden-boshlite-ubuntu-trusty
  plan:
  - aggregate:
    - get: version
      trigger: true
      passed: [build-stemcell]
    - get: bosh-stemcells-ci
    - get: bosh-linux-stemcell-builder
      passed: [build-stemcell]
    - get: stemcells-index
    - get: stemcell-trigger
      passed:
      - build-stemcell
      trigger: true
  - task: create-stemcell
    attempts: 3
    file: bosh-stemcells-ci/tasks/build.yml
    privileged: true
    params:
      IAAS:            warden
      HYPERVISOR:      boshlite
      OS_NAME:         ubuntu
      OS_VERSION:      trusty
      STEMCELL_BUCKET: bosh-core-stemcells-candidate
  - aggregate:
    - put: warden-boshlite-ubuntu-trusty
      attempts: 3
      params:
        file: stemcell/*.tgz
  - put: stemcells-index
    attempts: 3
    params:
      repository: stemcells-index
      rebase: true

#
# AWS
#

- name: build-aws-xen-hvm-ubuntu-trusty
  plan:
  - aggregate:
    - get: version
      trigger: true
      passed: [build-stemcell]
    - get: bosh-stemcells-ci
    - get: bosh-linux-stemcell-builder
      passed: [build-stemcell]
    - get: stemcells-index
    - get: stemcell-trigger
      passed:
      - build-stemcell
      trigger: true
  - task: create-stemcell
    attempts: 3
    file: bosh-stemcells-ci/tasks/build.yml
    privileged: true
    params:
      IAAS:            aws
      HYPERVISOR:      xen-hvm
      OS_NAME:         ubuntu
      OS_VERSION:      trusty
      STEMCELL_BUCKET: bosh-core-stemcells-candidate
  - aggregate:
    - put: aws-xen-hvm-ubuntu-trusty
      attempts: 3
      params:
        file: stemcell/*.tgz
  - put: stemcells-index
    attempts: 3
    params:
      repository: stemcells-index
      rebase: true

#
# Azure
#

- name: build-azure-hyperv-ubuntu-trusty
  plan:
  - aggregate:
    - get: version
      trigger: true
      passed: [build-stemcell]
    - get: bosh-stemcells-ci
    - get: bosh-linux-stemcell-builder
      passed: [build-stemcell]
    - get: stemcells-index
    - get: stemcell-trigger
      passed:
      - build-stemcell
      trigger: true
  - task: create-stemcell
    attempts: 3
    file: bosh-stemcells-ci/tasks/build.yml
    privileged: true
    params:
      IAAS:            azure
      HYPERVISOR:      hyperv
      OS_NAME:         ubuntu
      OS_VERSION:      trusty
      STEMCELL_BUCKET: bosh-core-stemcells-candidate
  - aggregate:
    - put: azure-hyperv-ubuntu-trusty
      attempts: 3
      params:
        file: stemcell/*.tgz
  - put: stemcells-index
    attempts: 3
    params:
      repository: stemcells-index
      rebase: true

#
# Google
#

- name: build-google-kvm-ubuntu-trusty
  plan:
  - aggregate:
    - get: version
      trigger: true
      passed: [build-stemcell]
    - get: bosh-stemcells-ci
    - get: bosh-linux-stemcell-builder
      passed: [build-stemcell]
    - get: stemcells-index
    - get: stemcell-trigger
      passed:
      - build-stemcell
      trigger: true
  - task: create-stemcell
    attempts: 3
    file: bosh-stemcells-ci/tasks/build.yml
    privileged: true
    params:
      IAAS:            google
      HYPERVISOR:      kvm
      OS_NAME:         ubuntu
      OS_VERSION:      trusty
      STEMCELL_BUCKET: bosh-core-stemcells-candidate
  - aggregate:
    - put: google-kvm-ubuntu-trusty
      attempts: 3
      params:
        file: stemcell/*-go_agent.tgz
  - put: stemcells-index
    attempts: 3
    params:
      repository: stemcells-index
      rebase: true

#
# OpenStack
#

- name: build-openstack-kvm-ubuntu-trusty
  plan:
  - aggregate:
    - get: version
      trigger: true
      passed: [build-stemcell]
    - get: bosh-stemcells-ci
    - get: bosh-linux-stemcell-builder
      passed: [build-stemcell]
    - get: stemcells-index
    - get: stemcell-trigger
      passed:
      - build-stemcell
      trigger: true
  - task: create-stemcell
    attempts: 3
    file: bosh-stemcells-ci/tasks/build.yml
    privileged: true
    params:
      IAAS:            openstack
      HYPERVISOR:      kvm
      OS_NAME:         ubuntu
      OS_VERSION:      trusty
      STEMCELL_BUCKET: bosh-core-stemcells-candidate
  - aggregate:
    - put: openstack-kvm-ubuntu-trusty-raw
      attempts: 3
      params:
        file: stemcell/*-raw.tgz
    - put: openstack-kvm-ubuntu-trusty
      attempts: 3
      params:
        file: stemcell/*-go_agent.tgz
  - put: stemcells-index
    attempts: 3
    params:
      repository: stemcells-index
      rebase: true

#
# vSphere
#

- name: build-vsphere-esxi-ubuntu-trusty
  plan:
  - aggregate:
    - get: version
      trigger: true
      passed: [build-stemcell]
    - get: bosh-stemcells-ci
    - get: bosh-linux-stemcell-builder
      passed: [build-stemcell]
    - get: stemcells-index
    - get: stemcell-trigger
      passed:
      - build-stemcell
      trigger: true
  - task: create-stemcell
    attempts: 3
    file: bosh-stemcells-ci/tasks/build.yml
    privileged: true
    params:
      IAAS:            vsphere
      HYPERVISOR:      esxi
      OS_NAME:         ubuntu
      OS_VERSION:      trusty
      STEMCELL_BUCKET: bosh-core-stemcells-candidate
  - aggregate:
    - put: vsphere-esxi-ubuntu-trusty
      attempts: 3
      params:
        file: stemcell/*.tgz
  - put: stemcells-index
    attempts: 3
    params:
      repository: stemcells-index
      rebase: true

#
# vCloud
#

- name: build-vcloud-esxi-ubuntu-trusty
  plan:
  - aggregate:
    - get: version
      trigger: true
      passed: [build-stemcell]
    - get: bosh-stemcells-ci
    - get: bosh-linux-stemcell-builder
      passed: [build-stemcell]
    - get: stemcells-index
    - get: stemcell-trigger
      passed:
      - build-stemcell
      trigger: true
  - task: create-stemcell
    attempts: 3
    file: bosh-stemcells-ci/tasks/build.yml
    privileged: true
    params:
      IAAS:            vcloud
      HYPERVISOR:      esxi
      OS_NAME:         ubuntu
      OS_VERSION:      trusty
      STEMCELL_BUCKET: bosh-core-stemcells-candidate
  - aggregate:
    - put: vcloud-esxi-ubuntu-trusty
      attempts: 3
      params:
        file: stemcell/*.tgz
  - put: stemcells-index
    attempts: 3
    params:
      repository: stemcells-index
      rebase: true

- name: bats-ubuntu
  serial: true
  plan:
  - aggregate:
    - get: bosh-release
    - get: cpi-release
    - get: stemcell
      trigger: true
      tags:
      - vsphere-v6.5
      resource: vsphere-esxi-ubuntu-trusty
      passed:
        - build-vsphere-esxi-ubuntu-trusty
    - get: bosh-cli
    - get: bats
    - get: bosh-deployment
    - get: bosh-stemcells-ci
    - get: bosh-linux-stemcell-builder
      passed:
      - build-warden-boshlite-ubuntu-trusty
      - build-aws-xen-hvm-ubuntu-trusty
      - build-azure-hyperv-ubuntu-trusty
      - build-google-kvm-ubuntu-trusty
      - build-openstack-kvm-ubuntu-trusty
      - build-vsphere-esxi-ubuntu-trusty
      - build-vcloud-esxi-ubuntu-trusty
    - get: version
      passed:
      - build-warden-boshlite-ubuntu-trusty
      - build-aws-xen-hvm-ubuntu-trusty
      - build-azure-hyperv-ubuntu-trusty
      - build-google-kvm-ubuntu-trusty
      - build-openstack-kvm-ubuntu-trusty
      - build-vsphere-esxi-ubuntu-trusty
      - build-vcloud-esxi-ubuntu-trusty
    - get: stemcell-trigger
      passed:
      - build-warden-boshlite-ubuntu-trusty
      - build-aws-xen-hvm-ubuntu-trusty
      - build-azure-hyperv-ubuntu-trusty
      - build-google-kvm-ubuntu-trusty
      - build-openstack-kvm-ubuntu-trusty
      - build-vsphere-esxi-ubuntu-trusty
      - build-vcloud-esxi-ubuntu-trusty
      trigger: true
  - do:
    - {put: environment, params: {acquire: true}}
    - do:
      - <<: *deploy-director
      - <<: *prepare-bats-config
        params:
          STEMCELL_NAME: bosh-vsphere-esxi-ubuntu-trusty-go_agent
      - <<: *run-bats
      ensure:
        do:
        - <<: *teardown
    ensure:
      do:
      - {put: environment, params: {release: environment}}

- name: delivery
  plan:
  - aggregate:
    - get: bosh-stemcells-ci
    - get: bosh-linux-stemcell-builder
      trigger: true
      passed:
      - bats-ubuntu
      - test-stemcells
  - put: tracker-output
    params:
      repos:
      - bosh-linux-stemcell-builder

- name: aggregate-candidate-stemcells
  plan:
  - aggregate:
    - get: version
      passed:
      - test-stemcells
      - bats-ubuntu
      trigger: true
    - get: bosh-stemcells-ci
    - get: bosh-linux-stemcell-builder
      passed:
      - bats-ubuntu
    - get: stemcells-index
    - get: stemcell-trigger
      passed:
      - test-stemcells
      - bats-ubuntu
      trigger: true
  - file: bosh-stemcells-ci/pipelines/ubuntu-trusty/3586.x/tasks/assert-version-aligns.yml
    task: assert-version-aligns
  - file: bosh-stemcells-ci/tasks/publish.yml
    params:
      AWS_ACCESS_KEY_ID: ((stemcell_aws_access_key))
      AWS_SECRET_ACCESS_KEY: ((stemcell_aws_secret_key))
      COMMIT_PREFIX: candidate
      FROM_BUCKET_NAME: bosh-core-stemcells-candidate
      FROM_INDEX: dev
      TO_BUCKET_NAME: bosh-core-stemcells-candidate
      TO_INDEX: candidate
      OS_NAME: ubuntu
      OS_VERSION: trusty
      COPY_KEYS: |
        aws/bosh-stemcell-%s-aws-xen-hvm-ubuntu-trusty-go_agent.tgz
        google/bosh-stemcell-%s-google-kvm-ubuntu-trusty-go_agent.tgz
        openstack/bosh-stemcell-%s-openstack-kvm-ubuntu-trusty-go_agent.tgz
        openstack/bosh-stemcell-%s-openstack-kvm-ubuntu-trusty-go_agent-raw.tgz
        warden/bosh-stemcell-%s-warden-boshlite-ubuntu-trusty-go_agent.tgz
        vsphere/bosh-stemcell-%s-vsphere-esxi-ubuntu-trusty-go_agent.tgz
        vcloud/bosh-stemcell-%s-vcloud-esxi-ubuntu-trusty-go_agent.tgz
        azure/bosh-stemcell-%s-azure-hyperv-ubuntu-trusty-go_agent.tgz
    task: copy-ubuntu-trusty-artifacts
  - aggregate:
    - put: bosh-linux-stemcell-builder-push
      params:
        repository: bosh-linux-stemcell-builder
        tag: version-tag/tag
        only_tag: true
    - put: stemcells-index
      params:
        rebase: true
        repository: stemcells-index
  serial: true

resource_types:
- name: usn
  type: docker-image
  source:
    repository: bosh/usn-resource

resources:
- name: bosh-stemcells-ci
  type: git
  source:
    uri: https://github.com/cloudfoundry/bosh-stemcells-ci
    branch: master

- name: slack-alert
  type: slack-notification
  source:
    url: ((slack_hook_url))

- name: bosh-linux-stemcell-builder
  type: git
  source:
    uri: https://github.com/cloudfoundry/bosh-linux-stemcell-builder
    branch: master

- name: bosh-linux-stemcell-builder-push
  type: git
  source:
    uri: git@github.com:cloudfoundry/bosh-linux-stemcell-builder
    branch: master
    private_key: ((bosh_src_key))

- name: stemcell-trigger
  type: s3
  source:
    access_key_id: ((bosh_usn_and_periodic_aws_access_key_id))
    bucket: bosh-stemcell-triggers
    secret_access_key: ((bosh_usn_and_periodic_aws_secret_access_key))
    versioned_file: 3586.x/stemcell-trigger

- name: stemcells-index
  type: git
  source:
    uri: git@github.com:bosh-io/stemcells-core-index.git
    branch: master
    private_key: ((boshio_stemcells_index_key))

- name: version
  type: semver
  source:
    <<: *stemcell_bucket
    driver: s3
    key: ((stemcell_version_key))

- name: syslog-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/syslog-release

- name: os-conf-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/os-conf-release

- name: bosh-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/bosh

- name: cpi-release
  type: bosh-io-release
  source:
    repository: cloudfoundry-incubator/bosh-vsphere-cpi-release

#
# WARDEN
#

- name: warden-boshlite-ubuntu-trusty
  type: s3
  source:
    <<: *stemcell_bucket
    regexp: warden/bosh-stemcell-(.+)-warden-boshlite-ubuntu-trusty-go_agent.tgz

#
# AWS
#

- name: aws-xen-hvm-ubuntu-trusty
  type: s3
  source:
    <<: *stemcell_bucket
    regexp: aws/bosh-stemcell-(.+)-aws-xen-hvm-ubuntu-trusty-go_agent.tgz

#
# Azure
#

- name: azure-hyperv-ubuntu-trusty
  type: s3
  source:
    <<: *stemcell_bucket
    regexp: azure/bosh-stemcell-(.+)-azure-hyperv-ubuntu-trusty-go_agent.tgz

#
# Google
#

- name: google-kvm-ubuntu-trusty
  type: s3
  source:
    <<: *stemcell_bucket
    regexp: google/bosh-stemcell-(.+)-google-kvm-ubuntu-trusty-go_agent.tgz

#
# OpenStack
#

- name: openstack-kvm-ubuntu-trusty
  type: s3
  source:
    <<: *stemcell_bucket
    regexp: openstack/bosh-stemcell-(.+)-openstack-kvm-ubuntu-trusty-go_agent.tgz

- name: openstack-kvm-ubuntu-trusty-raw
  type: s3
  source:
    <<: *stemcell_bucket
    regexp: openstack/bosh-stemcell-(.+)-openstack-kvm-ubuntu-trusty-go_agent-raw.tgz

#
# vSphere
#

- name: vsphere-esxi-ubuntu-trusty
  type: s3
  source:
    <<: *stemcell_bucket
    regexp: vsphere/bosh-stemcell-(.+)-vsphere-esxi-ubuntu-trusty-go_agent.tgz

#
# vCloud
#

- name: vcloud-esxi-ubuntu-trusty
  type: s3
  source:
    <<: *stemcell_bucket
    regexp: vcloud/bosh-stemcell-(.+)-vcloud-esxi-ubuntu-trusty-go_agent.tgz

- name: bosh-deployment
  type: git
  source:
    uri: https://github.com/cloudfoundry/bosh-deployment
    branch: master

- name: bosh-cli
  type: s3
  source:
    regexp: bosh-cli-([0-9.]+)-linux-amd64
    bucket: bosh-cli-artifacts
    region_name: us-east-1

- name: bats
  type: git
  source:
    uri: https://github.com/cloudfoundry/bosh-acceptance-tests.git
    branch: master

- name: environment
  type: pool
  source:
    pool: vsphere
    uri: git@github.com:pivotal-cf-experimental/bats-concourse-pool.git
    branch: master
    private_key: ((github_deployment_key__bosh-cpi-environments))

- name: tracker-output
  type: tracker
  source:
    project_id: ((story_creator_tracker_project_id))
    token: ((story_creator_tracker_token))
    tracker_url: https://www.pivotaltracker.com

#
# ubuntu-trusty
#

- name: ubuntu-trusty-tarball
  type: s3
  source:
    bucket: ((osimage_bucket))
    versioned_file: bosh-ubuntu-trusty-os-image.tgz
    access_key_id: ((osimage_aws_access_key))
    secret_access_key: ((osimage_aws_secret_key))

- name: every-2-weeks-on-monday
  type: time
  source:
    start: 6:00
    stop: 8:30
    location: America/Los_Angeles
    days: [Monday]
    interval: 192h

- name: trusty-usn
  type: usn
  source:
    os: ubuntu-14.04-lts
    priorities: [high, critical]
