- path: /groups/name=((group))/jobs/-
  type: replace
  value: publish-stemcells-((group))

- path: /groups/name=((group))/jobs/-
  type: replace
  value: aggregate-candidate-stemcells-((group))

- path: /jobs/-
  type: replace
  value:
    name: aggregate-candidate-stemcells-((group))
    serial: true
    plan:
    - aggregate:
      - get: version
        trigger: true
        resource: version-((group))
        passed:
        - bats-((group))
      - get: bosh-stemcells-ci
      - get: bosh-linux-stemcell-builder
        resource: bosh-linux-stemcell-builder-((group))
        passed:
        - bats-((group))
      - get: stemcells-index
    - file: bosh-stemcells-ci/pipelines/centos-7/((group))/tasks/assert-version-aligns.yml
      task: assert-version-aligns
    - file: bosh-stemcells-ci/tasks/publish.yml
      params:
        AWS_ACCESS_KEY_ID: ((stemcell_aws_access_key))
        AWS_SECRET_ACCESS_KEY: ((stemcell_aws_secret_key))
        COMMIT_PREFIX: candidate
        FROM_BUCKET_NAME: bosh-core-stemcells-candidate
        FROM_INDEX: dev
        TO_BUCKET_NAME: bosh-core-stemcells-candidate
        TO_INDEX: candidate
        OS_NAME: ubuntu
        OS_VERSION: xenial
        VERSION_PREFIX: centos-7/v
        COPY_KEYS: |
          aws/bosh-stemcell-%s-aws-xen-hvm-centos-7-go_agent.tgz
          google/bosh-stemcell-%s-google-kvm-centos-7-go_agent.tgz
          openstack/bosh-stemcell-%s-openstack-kvm-centos-7-go_agent.tgz
          openstack/bosh-stemcell-%s-openstack-kvm-centos-7-go_agent-raw.tgz
          warden/bosh-stemcell-%s-warden-boshlite-centos-7-go_agent.tgz
          vsphere/bosh-stemcell-%s-vsphere-esxi-centos-7-go_agent.tgz
          vcloud/bosh-stemcell-%s-vcloud-esxi-centos-7-go_agent.tgz
          azure/bosh-stemcell-%s-azure-hyperv-centos-7-go_agent.tgz
      task: copy-artifacts

- path: /jobs/-
  type: replace
  value:
    name: publish-stemcells-((group))
    serial: true
    plan:
    - aggregate:
      - get: version
        resource: version-((group))
        passed:
        - bats-((group))
      - get: bosh-stemcells-ci
      - get: bosh-linux-stemcell-builder
        resource: bosh-linux-stemcell-builder-((group))
        passed:
        - bats-((group))
      - get: stemcells-index
    - file: bosh-stemcells-ci/pipelines/centos-7/3763.x/tasks/assert-version-aligns.yml
      task: assert-version-aligns
    - file: bosh-stemcells-ci/tasks/publish.yml
      params:
        AWS_ACCESS_KEY_ID: ((stemcell_aws_access_key))
        AWS_SECRET_ACCESS_KEY: ((stemcell_aws_secret_key))
        CANDIDATE_BUCKET_NAME: ((candidate_stemcell_bucket))
        COPY_KEYS: |
          aws/bosh-stemcell-%s-aws-xen-hvm-centos-7-go_agent.tgz
          google/bosh-stemcell-%s-google-kvm-centos-7-go_agent.tgz
          openstack/bosh-stemcell-%s-openstack-kvm-centos-7-go_agent.tgz
          openstack/bosh-stemcell-%s-openstack-kvm-centos-7-go_agent-raw.tgz
          warden/bosh-stemcell-%s-warden-boshlite-centos-7-go_agent.tgz
          vsphere/bosh-stemcell-%s-vsphere-esxi-centos-7-go_agent.tgz
          vcloud/bosh-stemcell-%s-vcloud-esxi-centos-7-go_agent.tgz
          azure/bosh-stemcell-%s-azure-hyperv-centos-7-go_agent.tgz
        OS_NAME: centos
        OS_VERSION: "7"
        PUBLISHED_BUCKET_NAME: ((published_stemcell_bucket))
        VERSION_PREFIX: centos-7/v
      task: copy-artifacts
    - aggregate:
      - params:
          only_tag: true
          repository: bosh-linux-stemcell-builder
          tag: version-tag/tag
        put: bosh-linux-stemcell-builder-push-((group))
      - params:
          rebase: true
          repository: stemcells-index
        put: stemcells-index
    - task: build-release-metadata
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: alpine
        run:
          path: /bin/sh
          args:
          - -c
          - |
            version=$(cat version/version | sed 's/\.0$//')
            mkdir -p release-metadata
            echo -n "CentOS 7 v$version" > release-metadata/name
            echo -n "centos-7/v$version" > release-metadata/tag
            echo -n "Periodic CentOS 7 stemcell bump ($(date "+%h %d, %Y"))" > release-metadata/body
        inputs:
        - name: bosh-linux-stemcell-builder
        - name: version
        outputs:
        - name: release-metadata
    - put: gh-release
      params:
        body: release-metadata/body
        name: release-metadata/name
        tag: release-metadata/tag
